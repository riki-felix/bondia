---
/*
  RdsCalendarWidget
  Props:
	- anio: number
	- meses: {
		mes: number;
		gastos: number;
		ingresos: number;
		promocion: number;
		balance: number;
		balanceAjustado: number;
	  }[]
*/

import '../../styles/components/widgets.css';

interface MesResumen {
  mes: number;
  gastos: number;
  ingresos: number;
  promocion: number;
  balance: number;
  balanceAjustado: number;
  miParte: number;
}

// Helpers locales
const fmt = (value: number) =>
  new Intl.NumberFormat('es-ES', {
	style: 'currency',
	currency: 'EUR',
	minimumFractionDigits: 2,
	maximumFractionDigits: 2,
  }).format(value ?? 0);

const round2 = (value: number) =>
  Math.round((value ?? 0) * 100) / 100;

const { anio, meses = [] } = Astro.props as {
  anio: number;
  meses: MesResumen[];
};

const nombresMes = [
  "ENE", "FEB", "MAR", "ABR",
  "MAY", "JUN", "JUL", "AGO",
  "SEP", "OCT", "NOV", "DIC"
];

// Normalizamos a 12 meses, aunque vengan huecos
const mapMeses: Record<number, MesResumen> = {};
for (const m of meses) {
  mapMeses[m.mes] = {
	...m,
	gastos: round2(m.gastos ?? 0),
	ingresos: round2(m.ingresos ?? 0),
	promocion: round2(m.promocion ?? 0),
	balance: round2(
	  m.balance ?? (m.ingresos - m.gastos)
	),
	balanceAjustado: round2(
	  m.balanceAjustado ?? (m.ingresos - m.gastos - m.promocion)
	),
	miParte: round2(
	  m.miParte ?? (m.balanceAjustado / 2)
	),
  };
}

const rows: MesResumen[] = Array.from({ length: 12 }, (_, idx) => {
  const mesNum = idx + 1;
  return mapMeses[mesNum] ?? {
	mes: mesNum,
	gastos: 0,
	ingresos: 0,
	promocion: 0,
	balance: 0,
	balanceAjustado: 0,
  };
});

---

<section class="widget wg-size grid-10" aria-labelledby="wg-rds-calendar-title">
  <div class="widget-row--totals">
	<div class="widget-cell">
	  <span id="wg-rds-calendar-title" class="data-label label-l">
		Calendario
	  </span>
	</div>
  </div>

  <div class="widget-row">
	<div class="widget-cell">
	  <table class="widget-table rds-calendar-table">
		<thead>
		  <tr>
			<th></th>
			{rows.map((m) => (
			  <th>{nombresMes[m.mes - 1]}</th>
			))}
		  </tr>
		</thead>
	  
		<tbody>
		  <tr>
			<th class="row-title">Gastos</th>
			{rows.map((m) => (
			  <td>{fmt(m.gastos)}</td>
			))}
		  </tr>
	  
		  <tr>
			<th class="row-title">Ingresos</th>
			{rows.map((m) => (
			  <td>{fmt(m.ingresos)}</td>
			))}
		  </tr>
		 
		  <tr>
			<th class="row-title">Promoci√≥n</th>
			{rows.map((m) => (
			  <td>{fmt(-m.promocion)}</td>
			))}
		  </tr>
	  
		  <tr>
			<th class="row-title">Balance</th>
			{rows.map((m) => (
			  <td>{fmt(m.balance)}</td>
			))}
		  </tr>
	  <tr class="spacer-row">
		<td colspan="40"></td>
	  </tr>
		  <tr class="row-space">
			<th class="row-title">Balance real</th>
			{rows.map((m) => (
			  <td>{fmt(m.balanceAjustado)}</td>
			))}
		  </tr>
		  <tr class="row-space">
			<th class="row-title">Mi parte</th>
			{rows.map((m) => (
			  <td>{fmt(m.miParte)}</td>
			))}
		  </tr>
		</tbody>
	  </table>
	</div>
  </div>
</section>