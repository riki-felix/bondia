---
/*
  SumWidget
  Props:
	- propiedades: array de propiedades completas
	- tipo?: string           // filtro opcional por tipo (inversion, activo…)
	- campo: string           // campo a sumar (ej: "precio_compra", "precio_venta")
	- estado?: string         // filtro opcional por estado (vendido, liquidado…)
	- label?: string          // texto opcional
	- size?: number | string  // grid-X
*/

import WidgetShell from "./WidgetShell.astro";
import { toNum, formatEuro } from "../lib/money";
import { normalize } from "../lib/text";

interface Prop {
  id: string;
  tipo?: string | null;
  estado?: string | null;
  [key: string]: any;
}

interface Props {
  propiedades?: Prop[];
  tipo?: string;
  campo: string;
  estado?: string;
  label?: string;
  size?: number | string;
}

const {
  propiedades = [],
  tipo = "",
  campo = "precio_venta",
  estado = "",
  label = "",
  size = 3
} = Astro.props as Props;

// Normalización para comparar texto
const norm = (s: string | null | undefined) => normalize(s ?? "");

// 1. FILTRO GENERAL ------------------------------------
let filtered = propiedades;

if (tipo) {
  filtered = filtered.filter((p) => norm(p.tipo) === norm(tipo));
}

if (estado) {
  filtered = filtered.filter((p) => norm(p.estado) === norm(estado));
}

// 2. SUMA DEL CAMPO ELEGIDO ------------------------------
const suma = filtered.reduce((acc, p: any) => {
  return acc + toNum(p?.[campo]);
}, 0);

// 3. LABEL DINÁMICO --------------------------------------
const displayLabel =
  label ||
  (tipo && estado ? `Suma de ${campo} en ${tipo} (${estado})` :
   tipo            ? `Suma de ${campo} en ${tipo}` :
   estado          ? `Suma de ${campo} (${estado})` :
					 `Suma de ${campo}`);
---

<WidgetShell size={size} ariaLabelledBy="wg-sum-title">
  <div class="widget-row--totals">
	<div class="widget-cell">
	  <span id="wg-sum-title" class="data-label label-m">
		{displayLabel}
	  </span>

	  <span class="data-money data-xl">
		{formatEuro(suma)}
	  </span>
	</div>
  </div>
</WidgetShell>