---
export interface Props {
  mode: "create" | "edit";
  initial?: any | null;
}

const { mode = "create", initial = null } = Astro.props;
const isEdit = mode === "edit";
---

<form id="prop-form" novalidate>
  <h1>{isEdit ? `Editar propiedad: ${initial && initial.titulo ? initial.titulo : ""}` : "Nueva propiedad"}</h1>

  {isEdit && (
	<>
	  <input type="hidden" id="prop_id" name="id" value={initial && initial.id ? initial.id : ""} />
	  <p class="hint">ID: {initial && initial.id ? initial.id : ""}</p>
	</>
  )}

  <div class="sep"></div>

  <label for="titulo">Título</label>
  <input
	id="titulo"
	name="titulo"
	placeholder="Ej: Piso en Gràcia"
	required
	value={isEdit && initial && initial.titulo ? initial.titulo : ""}
  />

  <div class="row">
	<div>
	  <label for="numero_operacion">Nº de operación</label>
	  <input
		id="numero_operacion"
		name="numero_operacion"
		type="number"
		inputmode="numeric"
		placeholder="Ej: 12"
		value={isEdit && initial && initial.numero_operacion != null ? String(initial.numero_operacion) : ""}
	  />
	  <p class="hint">Se rellena automáticamente si lo dejas vacío, pero puedes romper la serie.</p>
	</div>

	<div>
	  <label for="tipo">Clasificación</label>
	  <select id="tipo" name="tipo" required>
		<option value="" selected={!isEdit}>Selecciona…</option>
		<option value="inversion" selected={isEdit && initial && initial.tipo === "inversion"}>Inversión</option>
		<option value="activo" selected={isEdit && initial && initial.tipo === "activo"}>Activo</option>
	  </select>
	</div>

	<div>
	  <label for="direccion">Dirección</label>
	  <input
		id="direccion"
		name="direccion"
		placeholder="Ej: Calle Mayor 12, 2º 1ª"
		value={isEdit && initial && initial.direccion ? initial.direccion : ""}
	  />
	</div>
  </div>

  <div class="row">
	<div>
	  <label for="superficie_m2">Superficie (m²)</label>
	  <input
		id="superficie_m2"
		name="superficie_m2"
		type="number"
		inputmode="numeric"
		placeholder="Ej: 72"
		value={isEdit && initial && initial.superficie_m2 != null ? String(initial.superficie_m2) : ""}
	  />
	</div>

	<div>
	  <label for="anio_construccion">Año construcción</label>
	  <input
		id="anio_construccion"
		name="anio_construccion"
		type="number"
		inputmode="numeric"
		placeholder="Ej: 1978"
		value={isEdit && initial && initial.anio_construccion != null ? String(initial.anio_construccion) : ""}
	  />
	</div>

	<div>
	  <label for="numero_catastro">Nº catastro</label>
	  <input
		id="numero_catastro"
		name="numero_catastro"
		placeholder="Ej: 1234567DF3813S0001AB"
		value={isEdit && initial && initial.numero_catastro ? initial.numero_catastro : ""}
	  />
	</div>
  </div>

  <div class="row">
	<div>
	  <label for="fecha_compra">Fecha compra</label>
	  <input
		id="fecha_compra"
		name="fecha_compra"
		type="date"
		value={isEdit && initial && initial.fecha_compra ? initial.fecha_compra : ""}
	  />
	</div>
  </div>

  <div class="sep"></div>

  <div class="row">
	<div>
	  <label for="precio_compra">Precio compra</label>
	  <input
		id="precio_compra"
		name="precio_compra"
		type="text"
		inputmode="decimal"
		placeholder="Ej: 120000,00"
		value={isEdit && initial && initial.precio_compra != null ? String(initial.precio_compra).replace(".", ",") : ""}
	  />
	</div>

	<div>
	  <label for="precio_venta">Precio venta</label>
	  <input
		id="precio_venta"
		name="precio_venta"
		type="text"
		inputmode="decimal"
		placeholder="Ej: 150000,00"
		value={isEdit && initial && initial.precio_venta != null ? String(initial.precio_venta).replace(".", ",") : ""}
	  />
	</div>

	<div>
	  <label for="alquiler_previsto">Alquiler previsto</label>
	  <input
		id="alquiler_previsto"
		name="alquiler_previsto"
		type="text"
		inputmode="decimal"
		placeholder="Ej: 950,00"
		value={isEdit && initial && initial.alquiler_previsto != null ? String(initial.alquiler_previsto).replace(".", ",") : ""}
	  />
	</div>
  </div>

  <div class="row">
	<div>
	  <label for="ingreso_banco">Ingreso Banco</label>
	  <input
		id="ingreso_banco"
		name="ingreso_banco"
		type="text"
		inputmode="decimal"
		placeholder="Ej: 12345,67"
		value={isEdit && initial && initial.ingreso_banco != null ? String(initial.ingreso_banco).replace(".", ",") : ""}
	  />
	  <p class="hint">Importe ingresado en cuenta (si aplica).</p>
	</div>
	<div>
	  <label for="fecha_ingreso">Fecha de ingreso</label>
	  <input
		id="fecha_ingreso"
		name="fecha_ingreso"
		type="date"
		value={isEdit && initial && initial.fecha_ingreso ? initial.fecha_ingreso : ""}
	  />
	</div>
	<div></div>
  </div>

  <div class="sep"></div>

  <div class="row">
	<div>
	  <label for="valor_catastro">Valor catastro</label>
	  <input
		id="valor_catastro"
		name="valor_catastro"
		type="text"
		inputmode="decimal"
		placeholder="Ej: 100000,00"
		value={isEdit && initial && initial.valor_catastro != null ? String(initial.valor_catastro).replace(".", ",") : ""}
	  />
	</div>

	<div>
	  <label for="valor_ite">ITE</label>
	  <input
		id="valor_ite"
		name="valor_ite"
		type="text"
		inputmode="decimal"
		placeholder="Ej: 0,00"
		value={isEdit && initial && initial.valor_ite != null ? String(initial.valor_ite).replace(".", ",") : ""}
	  />
	</div>

	<div>
	  <label for="coste_administrador">Administrador</label>
	  <input
		id="coste_administrador"
		name="coste_administrador"
		type="text"
		inputmode="decimal"
		placeholder="Ej: 50,00"
		value={isEdit && initial && initial.coste_administrador != null ? String(initial.coste_administrador).replace(".", ",") : ""}
	  />
	</div>
  </div>

  <div class="row">
	<div>
	  <label for="cuota_comunidad">Cuota comunidad</label>
	  <input
		id="cuota_comunidad"
		name="cuota_comunidad"
		type="text"
		inputmode="decimal"
		placeholder="Ej: 75,00"
		value={isEdit && initial && initial.cuota_comunidad != null ? String(initial.cuota_comunidad).replace(".", ",") : ""}
	  />
	</div>

	<div>
	  <label for="periodicidad_cuota">Periodicidad</label>
	  <select id="periodicidad_cuota" name="periodicidad_cuota">
		<option value="" selected={!isEdit || !initial || !initial.periodicidad_cuota}>—</option>
		<option value="mensual" selected={isEdit && initial && initial.periodicidad_cuota === "mensual"}>Mensual</option>
		<option value="bimensual" selected={isEdit && initial && initial.periodicidad_cuota === "bimensual"}>Bimensual</option>
		<option value="trimestral" selected={isEdit && initial && initial.periodicidad_cuota === "trimestral"}>Trimestral</option>
		<option value="anual" selected={isEdit && initial && initial.periodicidad_cuota === "anual"}>Anual</option>
	  </select>
	</div>

	<div>
	  <label for="ibi">IBI</label>
	  <input
		id="ibi"
		name="ibi"
		type="text"
		inputmode="decimal"
		placeholder="Ej: 320,00"
		value={isEdit && initial && initial.ibi != null ? String(initial.ibi).replace(".", ",") : ""}
	  />
	</div>
  </div>

  <div class="sep"></div>

  <label for="estado">Estado</label>
  <select id="estado" name="estado">
	<option value="tanteo" selected={!isEdit || (initial && initial.estado === "tanteo")}>Tanteo</option>
	<option value="comprado" selected={isEdit && initial && initial.estado === "comprado"}>Comprado</option>
	<option value="reformando" selected={isEdit && initial && initial.estado === "reformando"}>Reformando</option>
	<option value="alquilado" selected={isEdit && initial && initial.estado === "alquilado"}>Alquilado</option>
	<option value="vendido" selected={isEdit && initial && initial.estado === "vendido"}>Vendido</option>
  </select>

  <!-- ✅ NUEVO: Liquidación (toggle/checkbox) -->
  <div class="field">
	<label for="liquidacion">Liquidación</label>
	<label style="display:flex; align-items:center; gap:10px; margin-top:6px;">
	  <input
		id="liquidacion"
		name="liquidacion"
		type="checkbox"
		checked={isEdit && initial && initial.liquidacion ? true : false}
	  />
	  <span>Marcar como liquidada</span>
	</label>
  </div>

  <div class="sep"></div>

  <label for="suministro_luz">Luz</label>
  <select id="suministro_luz" name="suministro_luz">
	<option value="" selected={!isEdit || !initial || !initial.suministro_luz}>—</option>
	<option value="sin_suministro" selected={isEdit && initial && initial.suministro_luz === "sin_suministro"}>Sin suministro</option>
	<option value="pinchada" selected={isEdit && initial && (initial.suministro_luz === "pinchada" || initial.suministro_luz === "pinchado")}>Pinchada</option>
	<option value="contratada" selected={isEdit && initial && (initial.suministro_luz === "contratada" || initial.suministro_luz === "contratado")}>Contratada</option>
  </select>

  <label for="suministro_agua">Agua</label>
  <select id="suministro_agua" name="suministro_agua">
	<option value="" selected={!isEdit || !initial || !initial.suministro_agua}>—</option>
	<option value="sin_suministro" selected={isEdit && initial && initial.suministro_agua === "sin_suministro"}>Sin suministro</option>
	<option value="pinchada" selected={isEdit && initial && (initial.suministro_agua === "pinchada" || initial.suministro_agua === "pinchado")}>Pinchada</option>
	<option value="contratada" selected={isEdit && initial && (initial.suministro_agua === "contratada" || initial.suministro_agua === "contratado")}>Contratada</option>
  </select>

  <label for="suministro_gas">Gas</label>
  <select id="suministro_gas" name="suministro_gas">
	<option value="" selected={!isEdit || !initial || !initial.suministro_gas}>—</option>
	<option value="sin_suministro" selected={isEdit && initial && initial.suministro_gas === "sin_suministro"}>Sin suministro</option>
	<option value="pinchada" selected={isEdit && initial && (initial.suministro_gas === "pinchada" || initial.suministro_gas === "pinchado")}>Pinchada</option>
	<option value="contratada" selected={isEdit && initial && (initial.suministro_gas === "contratada" || initial.suministro_gas === "contratado")}>Contratada</option>
  </select>

  <div class="sep"></div>

  <label for="foto_destacada">Foto destacada</label>
  <input id="foto_destacada" name="foto_destacada" type="file" accept="image/jpeg,image/png" />

  <label for="plano">Plano</label>
  <input id="plano" name="plano" type="file" accept="image/jpeg,image/png" />

  <div class="actions">
	<button type="submit" id="submitBtn">{isEdit ? "Guardar cambios" : "Crear"}</button>
	{isEdit && <button type="button" id="deleteBtn" class="danger">Eliminar propiedad</button>}
  </div>

  <p id="msg"></p>
</form>

<style>
  form { max-width: 980px; margin: 0 auto; }
  .row { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 16px; }
  .field { margin: 12px 0; }
  .sep { margin: 18px 0; border-top: 1px solid rgba(0,0,0,.1); }
  .actions { display: flex; gap: 12px; margin-top: 18px; }
  .danger { background: #c62828; color: white; }
  .hint { font-size: 0.9rem; opacity: 0.75; }
  input, select { width: 100%; padding: 10px; box-sizing: border-box; }
  label { display: block; margin-top: 12px; font-weight: 600; }
</style>

<script is:inline define:vars={{ isEdit }}>
  const IS_EDIT = isEdit;
  const CREATE_ENDPOINT = "/.netlify/functions/createProperty";
  const UPDATE_ENDPOINT = "/.netlify/functions/updateProperty";
  const DELETE_ENDPOINT = "/.netlify/functions/deleteProperty";

  function emptyOrNull(v) {
	if (v == null) return null;
	const s = String(v).trim();
	return s === "" ? null : s;
  }

  function toIntOrNull(v) {
	const s = String(v == null ? "" : v).trim();
	if (!s) return null;
	const n = parseInt(s, 10);
	return Number.isFinite(n) ? n : null;
  }

  function canonMoneyNumber(v) {
	if (v == null) return null;
	let s = String(v).trim();
	if (!s) return null;
	s = s.replace(/\s+/g, "");

	const hasComma = s.includes(",");
	const hasDot = s.includes(".");

	if (hasComma && hasDot) {
	  s = s.replace(/\./g, "");
	  const last = s.lastIndexOf(",");
	  const intPart = s.slice(0, last).replace(/,/g, "");
	  const decPart = s.slice(last + 1);
	  s = intPart + (decPart ? ("." + decPart) : "");
	} else if (hasComma) {
	  s = s.replace(/\./g, "");
	  const last = s.lastIndexOf(",");
	  const intPart = s.slice(0, last).replace(/,/g, "");
	  const decPart = s.slice(last + 1);
	  s = intPart + (decPart ? ("." + decPart) : "");
	} else {
	  const last = s.lastIndexOf(".");
	  if (last >= 0) {
		const intPart = s.slice(0, last).replace(/\./g, "");
		const decPart = s.slice(last + 1);
		s = intPart + (decPart ? ("." + decPart) : "");
	  }
	}

	if (!/^\d+(\.\d+)?$/.test(s)) return null;
	const n = Number(s);
	if (!Number.isFinite(n)) return null;
	return Number(n.toFixed(2));
  }

  (function () {
	const form = document.getElementById("prop-form");
	const btn = document.getElementById("submitBtn");
	const msg = document.getElementById("msg");
	const del = document.getElementById("deleteBtn");

	if (!form || !btn || !msg) return;

	function getFieldValue(name) {
	  const el = form.elements && form.elements[name] ? form.elements[name] : null;
	  return el && typeof el.value !== "undefined" ? el.value : "";
	}

	function getFieldChecked(name) {
	  const el = form.elements && form.elements[name] ? form.elements[name] : null;
	  return !!(el && el.checked);
	}

	function refreshPeriodicidad() {
	  const cuota = canonMoneyNumber(getFieldValue("cuota_comunidad"));
	  const sel = form.elements && form.elements["periodicidad_cuota"] ? form.elements["periodicidad_cuota"] : null;
	  if (!sel) return;
	  sel.disabled = (cuota == null);
	  if (cuota == null) sel.value = "";
	}

	const cuotaInput = form.elements && form.elements["cuota_comunidad"] ? form.elements["cuota_comunidad"] : null;
	if (cuotaInput) {
	  cuotaInput.addEventListener("input", refreshPeriodicidad);
	  refreshPeriodicidad();
	}

	form.addEventListener("submit", async function (e) {
	  e.preventDefault();
	  btn.disabled = true;
	  msg.textContent = "";
	  msg.style.color = "";

	  var titulo = String(getFieldValue("titulo") || "").trim();
	  if (!titulo) {
		msg.textContent = "Introduce un título.";
		msg.style.color = "red";
		btn.disabled = false;
		return;
	  }

	  var tipo = String(getFieldValue("tipo") || "").trim().toLowerCase();
	  if (!tipo) {
		msg.textContent = "Selecciona la clasificación (Inversión o Activo).";
		msg.style.color = "red";
		btn.disabled = false;
		return;
	  }

	  // ID (solo edición)
	  var id = null;
	  if (IS_EDIT) {
		var idEl = document.getElementById("prop_id");
		id = (idEl && idEl.value) ? String(idEl.value).trim() : null;
		if (!id) {
		  msg.textContent = "ID requerido (no se ha podido leer el id de la propiedad).";
		  msg.style.color = "red";
		  btn.disabled = false;
		  return;
		}
	  }

	  var direccion = emptyOrNull(getFieldValue("direccion"));
	  var numero_operacion = toIntOrNull(getFieldValue("numero_operacion"));
	  var superficie_m2 = toIntOrNull(getFieldValue("superficie_m2"));
	  var anio_construccion = toIntOrNull(getFieldValue("anio_construccion"));
	  var numero_catastro = emptyOrNull(getFieldValue("numero_catastro"));
	  var fecha_compra = emptyOrNull(getFieldValue("fecha_compra"));

	  var precio_compra = canonMoneyNumber(getFieldValue("precio_compra"));
	  var precio_venta = canonMoneyNumber(getFieldValue("precio_venta"));
	  var alquiler_previsto = canonMoneyNumber(getFieldValue("alquiler_previsto"));

	  var ingreso_banco = canonMoneyNumber(getFieldValue("ingreso_banco"));
	  var fecha_ingreso = emptyOrNull(getFieldValue("fecha_ingreso"));

	  // ✅ liquidación (toggle)
	  var liquidacion = getFieldChecked("liquidacion");

	  var valor_catastro = canonMoneyNumber(getFieldValue("valor_catastro"));
	  var valor_ite = canonMoneyNumber(getFieldValue("valor_ite"));
	  var coste_administrador = canonMoneyNumber(getFieldValue("coste_administrador"));
	  var cuota_comunidad = canonMoneyNumber(getFieldValue("cuota_comunidad"));

	  var periodicidad_cuota = null;
	  if (cuota_comunidad != null) {
		var rawP = String(getFieldValue("periodicidad_cuota") || "").trim();
		periodicidad_cuota = rawP ? rawP : null;
	  }

	  var ibi = canonMoneyNumber(getFieldValue("ibi"));

	  var estadoRaw = String(getFieldValue("estado") || "").trim().toLowerCase();
	  var estado = estadoRaw ? estadoRaw : null;

	  var suministro_luz_raw = String(getFieldValue("suministro_luz") || "").trim().toLowerCase();
	  var suministro_luz = suministro_luz_raw ? suministro_luz_raw : null;

	  var suministro_agua_raw = String(getFieldValue("suministro_agua") || "").trim().toLowerCase();
	  var suministro_agua = suministro_agua_raw ? suministro_agua_raw : null;

	  var suministro_gas_raw = String(getFieldValue("suministro_gas") || "").trim().toLowerCase();
	  var suministro_gas = suministro_gas_raw ? suministro_gas_raw : null;

	  // Validación pareja ingreso/fecha
	  const hasIngreso = ingreso_banco != null;
	  const hasFechaIng = !!fecha_ingreso;
	  if ((hasIngreso && !hasFechaIng) || (!hasIngreso && hasFechaIng)) {
		msg.textContent = "Ingreso Banco y Fecha de ingreso deben informarse juntos (o ambos vacíos).";
		msg.style.color = "red";
		btn.disabled = false;
		return;
	  }

	  var payload = {
		tipo: tipo,
		titulo: titulo,
		direccion: direccion,
		numero_operacion: numero_operacion,
		superficie_m2: superficie_m2,
		anio_construccion: anio_construccion,
		numero_catastro: numero_catastro,
		fecha_compra: fecha_compra,
		precio_compra: precio_compra,
		precio_venta: precio_venta,
		alquiler_previsto: alquiler_previsto,
		ingreso_banco: ingreso_banco,
		fecha_ingreso: fecha_ingreso,
		liquidacion: liquidacion,
		valor_catastro: valor_catastro,
		valor_ite: valor_ite,
		coste_administrador: coste_administrador,
		cuota_comunidad: cuota_comunidad,
		periodicidad_cuota: periodicidad_cuota,
		ibi: ibi,
		estado: estado,
		suministro_luz: suministro_luz,
		suministro_agua: suministro_agua,
		suministro_gas: suministro_gas
	  };

	  if (IS_EDIT) payload.id = id;

	  try {
		msg.textContent = IS_EDIT ? "Guardando…" : "Creando…";

		var endpoint = IS_EDIT ? UPDATE_ENDPOINT : CREATE_ENDPOINT;

		var res = await fetch(endpoint, {
		  method: "POST",
		  headers: { "Content-Type": "application/json" },
		  body: JSON.stringify(payload)
		});

		var out = await res.json().catch(() => ({}));

		if (!res.ok) {
		  msg.textContent = out && out.error ? out.error : "Error guardando.";
		  msg.style.color = "red";
		  btn.disabled = false;
		  return;
		}

		msg.textContent = IS_EDIT ? "Guardado." : "Creado.";
		msg.style.color = "green";

		if (!IS_EDIT && out && out.id) {
		  window.location.href = `/admin/propiedad/${out.id}/editar`;
		} else {
		  btn.disabled = false;
		}
	  } catch (err) {
		console.error(err);
		msg.textContent = "Error inesperado.";
		msg.style.color = "red";
		btn.disabled = false;
	  }
	});

	if (del) {
	  del.addEventListener("click", async function () {
		if (!confirm("¿Seguro que quieres eliminar esta propiedad? Esta acción no se puede deshacer.")) return;

		const idEl = document.getElementById("prop_id");
		const id = (idEl && idEl.value) ? String(idEl.value).trim() : null;

		if (!id) {
		  alert("No se ha podido leer el ID.");
		  return;
		}

		del.disabled = true;

		try {
		  const res = await fetch(DELETE_ENDPOINT, {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify({ id })
		  });

		  const out = await res.json().catch(() => ({}));

		  if (!res.ok) {
			alert(out && out.error ? out.error : "Error eliminando.");
			del.disabled = false;
			return;
		  }

		  alert("Propiedad eliminada.");
		  window.location.href = "/admin/propiedades";
		} catch (e) {
		  console.error(e);
		  alert("Error inesperado eliminando.");
		  del.disabled = false;
		}
	  });
	}
  })();
</script>