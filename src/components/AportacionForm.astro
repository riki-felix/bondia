---
export interface Props {
  mode: 'create' | 'edit';
  initial?: any | null;
  propiedades?: { id: string; titulo: string }[];
}

const { mode = 'create', initial = null, propiedades = [] } = Astro.props;
const isEdit = mode === 'edit';
---

<form id="aport-form" novalidate>
  <h1>{isEdit ? `Editar aportación` : 'Nueva aportación'}</h1>

  {isEdit && <input type="hidden" id="aport_id" name="id" value={initial?.id} />}

  <!-- Concepto -->
  <div class="field">
	<label for="concepto">Concepto</label>
	<input
	  id="concepto"
	  name="concepto"
	  type="text"
	  required
	  value={initial?.concepto ?? ''}
	/>
  </div>

  <!-- Fecha -->
  <div class="field">
	<label for="fecha">Fecha</label>
	<input
	  id="fecha"
	  name="fecha"
	  type="date"
	  required
	  value={initial?.fecha ? initial.fecha.substring(0, 10) : ''}
	/>
  </div>

  <!-- Importe -->
  <div class="field">
	<label for="importe">Importe (€)</label>
	<input
	  id="importe"
	  name="importe"
	  type="number"
	  step="0.01"
	  min="0"
	  required
	  value={initial?.importe ?? ''}
	/>
  </div>

  <!-- Propiedad (opcional) -->
  <div class="field">
	<label for="propiedad_id">Propiedad (opcional)</label>
	<select id="propiedad_id" name="propiedad_id">
	  <option value="">— Sin asignar —</option>
	  {propiedades.map((prop) => (
		<option
		  value={prop.id}
		  selected={initial?.propiedad_id === prop.id}
		>
		  {prop.titulo}
		</option>
	  ))}
	</select>
  </div>

  <!-- Modo de pago -->
  <div class="field">
	<label for="modo_pago">Modo de pago</label>
	<select id="modo_pago" name="modo_pago" required>
	  <option value="transferencia" selected={initial?.modo_pago === 'transferencia'}>Transferencia</option>
	  <option value="efectivo" selected={initial?.modo_pago === 'efectivo'}>Efectivo</option>
	</select>
  </div>

  <!-- Autor -->
  <div class="field">
	<label for="autor">Autor</label>
	<select id="autor" name="autor" required>
	  <option value="Sanyus" selected={initial?.autor === 'Sanyus'}>Sanyus</option>
	  <option value="Blaster" selected={initial?.autor === 'Blaster'}>Blaster</option>
	</select>
  </div>

  <!-- Justificante: de momento manejamos solo la ruta -->
  <div class="field">
	<label for="justificante_path">Justificante (ruta PDF/JPG)</label>
	<input
	  id="justificante_path"
	  name="justificante_path"
	  type="text"
	  placeholder="ruta/en/storage.pdf"
	  value={initial?.justificante_path ?? ''}
	/>
	<!--
	  TODO: aquí puedes enganchar la misma lógica de subida de archivos que uses en PropertyForm
	  (Supabase Storage) y rellenar justificante_path con la ruta subida.
	-->
  </div>

  <button id="save-btn" type="submit">
	{isEdit ? 'Guardar cambios' : 'Crear aportación'}
  </button>

  {isEdit && (
	<button id="delete-btn" type="button" class="danger">
	  Eliminar aportación
	</button>
  )}

  <p id="aport-msg"></p>
</form>

<script>
  const form = document.querySelector('#aport-form');
  const msg = document.querySelector('#aport-msg');
  const saveBtn = document.querySelector('#save-btn');
  const deleteBtn = document.querySelector('#delete-btn');

  form?.addEventListener('submit', async (e) => {
	e.preventDefault();
	msg.textContent = '';
	saveBtn.disabled = true;

	const formData = new FormData(form);
	const body = Object.fromEntries(formData.entries());

	// Si propiedad_id es "", lo eliminamos para que el backend lo trate como null
	if (!body.propiedad_id) delete body.propiedad_id;

	try {
	  const endpoint =
		form.querySelector('#aport_id')
		  ? '/.netlify/functions/aportacion-update'
		  : '/.netlify/functions/aportacion-create';

	  const res = await fetch(endpoint, {
		method: 'POST',
		headers: { 'Content-Type': 'application/json' },
		body: JSON.stringify(body),
	  });

	  const data = await res.json();

	  if (!res.ok) throw new Error(data.error || 'Error al guardar');

	  msg.textContent = '✔️ Aportación guardada';
	  msg.style.color = 'green';

	  if (!form.querySelector('#aport_id')) {
		// Si es nueva, recarga el listado admin
		setTimeout(() => (window.location.href = '/admin/aportaciones'), 600);
	  }
	} catch (err) {
	  console.error('[guardar aportación] Error', err);
	  msg.textContent = `❌ ${err.message || err}`;
	  msg.style.color = 'red';
	} finally {
	  saveBtn.disabled = false;
	}
  });

  if (deleteBtn) {
	deleteBtn.addEventListener('click', async () => {
	  if (!confirm('¿Eliminar esta aportación?')) return;
	  deleteBtn.disabled = true;
	  msg.textContent = '';

	  try {
		const id = (document.querySelector('#aport_id') as HTMLInputElement).value;
		const res = await fetch('/.netlify/functions/aportacion-delete', {
		  method: 'POST',
		  headers: { 'Content-Type': 'application/json' },
		  body: JSON.stringify({ id }),
		});
		const data = await res.json();
		if (!res.ok) throw new Error(data.error || 'Error al eliminar');

		msg.textContent = '✔️ Aportación eliminada';
		msg.style.color = 'green';
		setTimeout(() => (window.location.href = '/admin/aportaciones'), 600);
	  } catch (err) {
		console.error('[eliminar aportación] Error', err);
		msg.textContent = `❌ ${err.message || err}`;
		msg.style.color = 'red';
	  } finally {
		deleteBtn.disabled = false;
	  }
	});
  }
</script>