---
export interface Props {
  mode: 'create' | 'edit';
  initial?: any | null;
  propiedades?: { id: string; titulo: string }[];
}

const { mode = 'create', initial = null, propiedades = [] } = Astro.props;
const isEdit = mode === 'edit';
---

<form id="aport-form" novalidate>
  <h1>{isEdit ? `Editar aportación` : 'Nueva aportación'}</h1>

  {isEdit && <input type="hidden" id="aport_id" name="id" value={initial?.id} />}

  <!-- Concepto -->
  <div class="field">
	<label for="concepto">Concepto</label>
	<input
	  id="concepto"
	  name="concepto"
	  type="text"
	  required
	  value={initial?.concepto ?? ''}
	/>
  </div>

  <!-- Fecha -->
  <div class="field">
	<label for="fecha">Fecha</label>
	<input
	  id="fecha"
	  name="fecha"
	  type="date"
	  required
	  value={initial?.fecha ? initial.fecha.substring(0, 10) : ''}
	/>
  </div>

  <!-- Importe -->
  <div class="field">
	<label for="importe">Importe (€)</label>
	<input
	  id="importe"
	  name="importe"
	  type="number"
	  step="0.01"
	  min="0"
	  required
	  value={initial?.importe ?? ''}
	/>
  </div>

  <!-- Propiedad (opcional) -->
  <div class="field">
	<label for="propiedad_id">Propiedad (opcional)</label>
	<select id="propiedad_id" name="propiedad_id">
	  <option value="">— Sin asignar —</option>
	  {propiedades.map((prop) => (
		<option
		  value={prop.id}
		  selected={initial?.propiedad_id === prop.id}
		>
		  {prop.titulo}
		</option>
	  ))}
	</select>
  </div>

  <!-- Modo de pago -->
  <div class="field">
	<label for="modo_pago">Modo de pago</label>
	<select id="modo_pago" name="modo_pago" required>
	  <option value="transferencia" selected={initial?.modo_pago === 'transferencia'}>Transferencia</option>
	  <option value="efectivo" selected={initial?.modo_pago === 'efectivo'}>Efectivo</option>
	</select>
  </div>

  <!-- Autor -->
  <div class="field">
	<label for="autor">Autor</label>
	<select id="autor" name="autor" required>
	  <option value="Sanyus" selected={initial?.autor === 'Sanyus'}>Sanyus</option>
	  <option value="Blaster" selected={initial?.autor === 'Blaster'}>Blaster</option>
	</select>
  </div>

  <!-- Justificante: de momento manejamos solo la ruta -->
  <div class="field">
	<label for="justificante_path">Justificante (ruta PDF/JPG)</label>
	<input
	  id="justificante_path"
	  name="justificante_path"
	  type="text"
	  placeholder="ruta/en/storage.pdf"
	  value={initial?.justificante_path ?? ''}
	/>
	<!--
	  TODO: aquí puedes enganchar la misma lógica de subida de archivos que uses en PropertyForm
	  (Supabase Storage) y rellenar justificante_path con la ruta subida.
	-->
  </div>

  <button id="save-btn" type="submit">
	{isEdit ? 'Guardar cambios' : 'Crear aportación'}
  </button>

  {isEdit && (
	<button id="delete-btn" type="button" class="danger">
	  Eliminar aportación
	</button>
  )}

  <p id="aport-msg"></p>
</form>

<script type="module">
  const form    = document.getElementById("aportacion-form");
	const msgEl   = document.getElementById("aportacion-msg");
	const saveBtn = document.getElementById("aportacion-save");
	const deleteBtn = document.getElementById("aportacion-delete");

  function setMessage() {
	if (!msgEl) return;
	msgEl.textContent = text;
	msgEl.style.color = kind === "ok" ? "green" : "red";
  }

  async function handleSave(ev) {
	ev.preventDefault();
	if (!form) return;

	if (msgEl) msgEl.textContent = "";
	if (saveBtn) saveBtn.disabled = true;

	try {
	  const formData = new FormData(form);
	  setMessage("ok", "✔️ Aportación guardada");
	  if (deleteBtn) deleteBtn.disabled = false;
	} catch (err) {
	  const msg =
		err instanceof Error ? err.message : typeof err === "string" ? err : String(err);
	  setMessage("error", `❌ ${msg}`);
	} finally {
	  if (saveBtn) saveBtn.disabled = false;
	}
  }

  async function handleDelete(ev) {
	ev.preventDefault();
	if (!form) return;

	if (msgEl) msgEl.textContent = "";
	if (deleteBtn) deleteBtn.disabled = true;

	try {
	  setMessage("ok", "✔️ Aportación eliminada");
	} catch (err) {
	  const msg =
		err instanceof Error ? err.message : typeof err === "string" ? err : String(err);
	  setMessage("error", `❌ ${msg}`);
	  if (deleteBtn) deleteBtn.disabled = false;
	}
  }

  form?.addEventListener("submit", handleSave);
  deleteBtn?.addEventListener("click", handleDelete);
</script>