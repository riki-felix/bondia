---
export const prerender = false;

import Admin from "../../../components/Admin.astro";
import { supabaseServer } from "../../../lib/supabaseServer";

interface PisoRds {
  id: string;
  nombre: string;
  direccion?: string;
  fecha_creacion: string;
}

interface MovimientoRds {
  id: string;
  piso_id: string;
  anio: number;
  mes: number;
  gasto: number;
  ingreso: number;
  promocion: number; // sigue existiendo en la tabla, pero no lo usamos aquí
}

const { id } = Astro.params;

const url = Astro.url;
const now = new Date();
const currentYear = now.getFullYear();
const selectedYear = Number(url.searchParams.get("year") ?? currentYear);

const supabase = supabaseServer();

// Piso
const { data: pisoData, error: pisoError } = await supabase
  .from("rds_pisos")
  .select("*")
  .eq("id", id)
  .single();

if (pisoError || !pisoData) {
  console.error("Error rds_pisos:", pisoError?.message);
  throw new Error("Piso RDS no encontrado");
}

const piso = pisoData as PisoRds;

// Movimientos de este piso y año
const { data: movsData, error: movsError } = await supabase
  .from("rds_movimientos")
  .select("*")
  .eq("piso_id", id)
  .eq("anio", selectedYear);

if (movsError) {
  console.error("Error rds_movimientos:", movsError.message);
}

const movimientos = (movsData ?? []) as MovimientoRds[];

// Mapa mes → datos (solo gasto / ingreso, sin promo)
const mapMes: Record<number, { gasto: number; ingreso: number }> = {};
for (const m of movimientos) {
  mapMes[m.mes] = {
	gasto: m.gasto ?? 0,
	ingreso: m.ingreso ?? 0,
  };
}

const nombresMesLargo = [
  "Enero", "Febrero", "Marzo", "Abril",
  "Mayo", "Junio", "Julio", "Agosto",
  "Septiembre", "Octubre", "Noviembre", "Diciembre"
];

// Formateo a dinero en formato ES (1.234,56)
function formatMoneyEs(n: number): string {
  if (!Number.isFinite(n)) return "";
  return new Intl.NumberFormat("es-ES", {
	minimumFractionDigits: 2,
	maximumFractionDigits: 2,
  }).format(n);
}
---

<Admin>
  <header>
	<div>
	  <h1 style="margin:.25rem 0 .25rem">{piso.nombre}</h1>
	  <p class="muted">{piso.direccion}</p>
	</div>

	<div class="topbar">
	  <form method="get" class="year-filter">
		<input type="hidden" name="id" value={piso.id} />
		<label for="year">Año</label>
		<select id="year" name="year">
		  {Array.from({ length: 6 }, (_, i) => {
			const y = currentYear - 2 + i;
			return (
			  <option value={y} selected={y === selectedYear}>
				{y}
			  </option>
			);
		  })}
		</select>
		<noscript>
		  <button type="submit">Aplicar</button>
		</noscript>
	  </form>
	</div>
  </header>

  <main class="rds-detail-layout" data-piso-id={piso.id} data-year={selectedYear}>
	<section>
	  <h2>Movimientos por mes ({selectedYear})</h2>
	  <p class="muted">
		Un registro por mes. Los importes se guardan para el año seleccionado.
	  </p>

	  <form id="rds-mov-form">
		<input type="hidden" name="piso_id" value={piso.id} />
		<input type="hidden" name="anio" value={selectedYear} />

		<table class="rds-table">
		  <thead>
			<tr>
			  <th></th>
			  {Array.from({ length: 12 }, (_, idx) => {
				const mes = idx + 1;
				return <th>{nombresMesLargo[mes - 1]}</th>;
			  })}
			</tr>
		  </thead>
		  <tbody>
			<tr>
			  <th>Gasto</th>
			  {Array.from({ length: 12 }, (_, idx) => {
				const mes = idx + 1;
				const datos = mapMes[mes] ?? {
				  gasto: 0,
				  ingreso: 0,
				};
				return (
				  <td>
					<input
					  type="text"
					  inputmode="decimal"
					  name={`mes_${mes}_gasto`}
					  value={formatMoneyEs(datos.gasto)}
					/>
				  </td>
				);
			  })}
			</tr>

			<tr>
			  <th>Ingreso</th>
			  {Array.from({ length: 12 }, (_, idx) => {
				const mes = idx + 1;
				const datos = mapMes[mes] ?? {
				  gasto: 0,
				  ingreso: 0,
				};
				return (
				  <td>
					<input
					  type="text"
					  inputmode="decimal"
					  name={`mes_${mes}_ingreso`}
					  value={formatMoneyEs(datos.ingreso)}
					/>
				  </td>
				);
			  })}
			</tr>
		  </tbody>
		</table>

		<div class="form-actions">
		  <button type="submit" class="btn">Guardar movimientos</button>
		</div>

		<p id="rds-mov-status" class="muted"></p>
	  </form>
	</section>

	<section class="danger-zone">
	  <h2>Peligro</h2>
	  <p class="muted">
		Borrar este piso RDS eliminará también sus movimientos asociados. 
		Esta acción no se puede deshacer.
	  </p>

	  <div class="form-actions">
		<button type="button" class="btn btn-danger" id="rds-delete-open">
		  Borrar piso RDS
		</button>
	  </div>
	</section>

	{/* Modal de confirmación de borrado */}
	<div class="rds-modal" id="rds-delete-modal" aria-hidden="true">
	  <div class="rds-modal-backdrop"></div>
	  <div class="rds-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="rds-delete-title">
		<h2 id="rds-delete-title">Confirmar borrado</h2>
		<p class="muted">
		  Esta acción borrará el piso <strong>{piso.nombre}</strong> y todos sus movimientos 
		  en todos los años. Escribe <code>borrar</code> para activar el botón de confirmación.
		</p>

		<label for="rds-delete-confirm" class="muted">
		  Escribe <code>borrar</code>:
		</label>
		<input
		  id="rds-delete-confirm"
		  type="text"
		  placeholder="borrar"
		  autocomplete="off"
		/>

		<div class="modal-actions">
		  <button type="button" class="btn btn-secondary" id="rds-delete-cancel">
			Cancelar
		  </button>
		  <button
			type="button"
			class="btn btn-danger"
			id="rds-delete-confirm-btn"
			disabled
		  >
			Confirmar borrado
		  </button>
		</div>

		<p id="rds-delete-error" class="muted" hidden></p>
	  </div>
	</div>
  </main>
</Admin>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
	// --- Filtro de año: recarga la página con ?year= ---
	const yearForm = document.querySelector('.year-filter');
	if (yearForm) {
	  const yearSelect = yearForm.querySelector('select[name="year"]');
	  if (yearSelect) {
		yearSelect.addEventListener('change', () => {
		  yearForm.submit();
		});
	  }
	}

	// --- Helpers para dinero (igual estilo que en _shared.ts) ---
	function normalizeMoneyLike(v) {
	  if (v == null) return "0";
	  let s = String(v).trim();
	  if (!s) return "0";
	  s = s.replace(/\s+/g, "");
	  const hasComma = s.includes(",");
	  if (hasComma) {
		s = s.replace(/\./g, "");
		const last = s.lastIndexOf(",");
		const intPart = s.slice(0, last).replace(/,/g, "");
		const decPart = s.slice(last + 1);
		s = intPart + (decPart ? "." + decPart : "");
	  } else {
		const last = s.lastIndexOf(".");
		if (last >= 0) {
		  const intPart = s.slice(0, last).replace(/\./g, "");
		  const decPart = s.slice(last + 1);
		  s = intPart + (decPart ? "." + decPart : "");
		}
	  }
	  if (!/^\d+(\.\d+)?$/.test(s)) return "0";
	  return s;
	}

	function toMoneyOrZero(v) {
	  const canon = normalizeMoneyLike(v);
	  if (canon == null) return 0;
	  const n = Number(canon);
	  if (!Number.isFinite(n)) return 0;
	  if (Math.trunc(Math.abs(n)) >= 1000000000) return 0;
	  return Number(n.toFixed(2));
	}

	// --- Formulario de movimientos ---
	const movForm = document.getElementById('rds-mov-form');
	const statusEl = document.getElementById('rds-mov-status');

	function setMovStatus(msg, isError) {
	  if (!statusEl) return;
	  statusEl.textContent = msg;
	  statusEl.style.color = isError ? '#c00' : '#555';
	}

	if (movForm) {
	  movForm.addEventListener('submit', async (ev) => {
		ev.preventDefault();
		setMovStatus('', false);

		const fd = new FormData(movForm);
		const pisoId = fd.get('piso_id');
		const anioStr = fd.get('anio');

		const anio = Number(anioStr);
		if (!pisoId || !anio || !Number.isFinite(anio)) {
		  setMovStatus('Error: datos de piso/año inválidos', true);
		  return;
		}

		const meses = [];
		for (let mes = 1; mes <= 12; mes++) {
		  const gastoRaw = fd.get(`mes_${mes}_gasto`) || '0';
		  const ingresoRaw = fd.get(`mes_${mes}_ingreso`) || '0';

		  const gasto = toMoneyOrZero(gastoRaw);
		  const ingreso = toMoneyOrZero(ingresoRaw);

		  meses.push({
			mes,
			gasto,
			ingreso,
			// sin "promocion": en el backend se convertirá a 0 por defecto
		  });
		}

		try {
		  const resp = await fetch('/.netlify/functions/rds_movimientos_save', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({
			  piso_id: pisoId,
			  anio,
			  meses,
			}),
		  });

		  if (!resp.ok) {
			const txt = await resp.text();
			throw new Error(txt || 'Error HTTP ' + resp.status);
		  }

		  const json = await resp.json();
		  if (json.error) {
			throw new Error(json.error);
		  }

		  setMovStatus('Movimientos guardados correctamente.', false);
		} catch (err) {
		  console.error('Error guardando movimientos RDS:', err);
		  setMovStatus('Error al guardar movimientos.', true);
		}
	  });
	}

	// --- Modal de borrado ---
	const deleteOpenBtn = document.getElementById('rds-delete-open');
	const deleteModal = document.getElementById('rds-delete-modal');
	const deleteCancelBtn = document.getElementById('rds-delete-cancel');
	const deleteConfirmInput = document.getElementById('rds-delete-confirm');
	const deleteConfirmBtn = document.getElementById('rds-delete-confirm-btn');
	const deleteErrorEl = document.getElementById('rds-delete-error');

	function openDeleteModal() {
	  if (!deleteModal) return;
	  deleteModal.setAttribute('aria-hidden', 'false');
	  deleteModal.classList.add('is-open');
	  if (deleteConfirmInput) {
		deleteConfirmInput.value = '';
		deleteConfirmInput.focus();
	  }
	  if (deleteConfirmBtn) {
		deleteConfirmBtn.disabled = true;
	  }
	  if (deleteErrorEl) {
		deleteErrorEl.hidden = true;
		deleteErrorEl.textContent = '';
	  }
	  document.body.style.overflow = 'hidden';
	}

	function closeDeleteModal() {
	  if (!deleteModal) return;
	  deleteModal.setAttribute('aria-hidden', 'true');
	  deleteModal.classList.remove('is-open');
	  document.body.style.overflow = '';
	}

	if (deleteOpenBtn) {
	  deleteOpenBtn.addEventListener('click', openDeleteModal);
	}

	if (deleteCancelBtn) {
	  deleteCancelBtn.addEventListener('click', closeDeleteModal);
	}

	if (deleteModal) {
	  const backdrop = deleteModal.querySelector('.rds-modal-backdrop');
	  if (backdrop) {
		backdrop.addEventListener('click', closeDeleteModal);
	  }
	}

	if (deleteConfirmInput && deleteConfirmBtn) {
	  deleteConfirmInput.addEventListener('input', () => {
		const value = deleteConfirmInput.value.trim().toLowerCase();
		deleteConfirmBtn.disabled = value !== 'borrar';
	  });
	}

	if (deleteConfirmBtn && deleteErrorEl) {
	  deleteConfirmBtn.addEventListener('click', async () => {
		const datasetRoot = document.querySelector('.rds-detail-layout');
		const pisoId = datasetRoot?.getAttribute('data-piso-id') || '';
		if (!pisoId) {
		  deleteErrorEl.hidden = false;
		  deleteErrorEl.textContent = 'Error: ID de piso no encontrado.';
		  return;
		}

		deleteConfirmBtn.disabled = true;
		deleteErrorEl.hidden = true;
		deleteErrorEl.textContent = '';

		try {
		  const resp = await fetch('/.netlify/functions/rds_piso_save', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({
			  id: pisoId,
			  delete: true,
			}),
		  });

		  if (!resp.ok) {
			const txt = await resp.text();
			throw new Error(txt || 'Error HTTP ' + resp.status);
		  }

		  const json = await resp.json();
		  if (json.error) {
			throw new Error(json.error);
		  }

		  window.location.href = '/admin/rds';
		} catch (err) {
		  console.error('Error borrando piso RDS:', err);
		  deleteErrorEl.hidden = false;
		  deleteErrorEl.textContent = 'Error al borrar el piso. Inténtalo de nuevo.';
		  deleteConfirmBtn.disabled = false;
		}
	  });
	}
  });
</script>

<style>
  .rds-detail-layout {
	display: grid;
	grid-template-columns: minmax(0, 3fr) minmax(0, 2fr);
	gap: 2rem;
	align-items: flex-start;
  }

  .rds-table {
	width: 100%;
	border-collapse: collapse;
  }

  .rds-table th,
  .rds-table td {
	border: 1px solid #ddd;
	padding: .3rem .4rem;
	font-size: .85rem;
  }

  .rds-table th {
	background: #fafafa;
	white-space: nowrap;
  }

  .rds-table input[type="text"] {
	width: 100%;
	box-sizing: border-box;
	text-align: right;
  }

  .form-actions {
	margin-top: 1rem;
	display: flex;
	gap: .5rem;
	align-items: center;
  }

  .danger-zone {
	border: 1px solid #f5c2c7;
	background: #fff5f5;
	padding: 1rem;
	border-radius: .5rem;
  }

  .danger-zone h2 {
	color: #b02a37;
	margin-top: 0;
  }

  .btn.btn-danger {
	background: #b02a37;
	border-color: #b02a37;
	color: #fff;
  }

  .btn.btn-secondary {
	background: #e0e0e0;
	border-color: #ccc;
	color: #333;
  }

  /* Modal */
  .rds-modal {
	position: fixed;
	inset: 0;
	display: none;
	z-index: 999;
  }

  .rds-modal.is-open {
	display: block;
  }

  .rds-modal-backdrop {
	position: absolute;
	inset: 0;
	background: rgba(0,0,0,0.4);
  }

  .rds-modal-dialog {
	position: relative;
	max-width: 420px;
	margin: 10vh auto;
	background: #fff;
	padding: 1.5rem;
	border-radius: .75rem;
	box-shadow:
	  0 10px 15px -3px rgba(0,0,0,0.1),
	  0 4px 6px -4px rgba(0,0,0,0.1);
  }

  .rds-modal-dialog h2 {
	margin-top: 0;
	margin-bottom: .5rem;
  }

  .rds-modal-dialog input[type="text"] {
	width: 100%;
	max-width: 12rem;
	margin-top: .5rem;
	margin-bottom: .5rem;
  }

  .modal-actions {
	margin-top: 1rem;
	display: flex;
	gap: .5rem;
	justify-content: flex-end;
  }
</style>