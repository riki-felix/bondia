---
export const prerender = false;

import Admin from "../../../components/Admin.astro";
import SectionHeader from "../../../components/SectionHeader.astro";
import "../../../styles/components/section-toolbar.css";
import "../../../styles/components/tables.css";
import RdsCountWidget from "../../../widgets/rds/RdsCountWidget.astro";
import RdsTotalsWidget from "../../../widgets/rds/RdsTotalsWidget.astro";
import RdsCalendarWidget from "../../../widgets/rds/RdsCalendarWidget.astro";
import { fmt, round2 } from "../../../widgets/propContext";

import { createSupabaseServerClient } from "../../../lib/supabaseServer";

interface PisoRds {
  id: string;
  nombre: string;
  direccion?: string;
  fecha_creacion: string;
}

interface MovimientoRds {
  id: string;
  piso_id: string;
  anio: number;
  mes: number;
  gasto: number;
  ingreso: number;
  promocion: number;
}

const url = Astro.url;
const now = new Date();
const currentYear = now.getFullYear();
const selectedYear = Number(url.searchParams.get("year") ?? currentYear);

const supabase = createSupabaseServerClient(Astro.cookies, Astro.request);

// Pisos, ordenados por fecha de creación
const { data: pisosData, error: pisosError } = await supabase
  .from("rds_pisos")
  .select("*")
  .order("fecha_creacion", { ascending: true });

if (pisosError) {
  console.error("Error rds_pisos:", pisosError.message);
}

const pisos = (pisosData ?? []) as PisoRds[];

// Movimientos solo del año seleccionado
const { data: movsData, error: movsError } = await supabase
  .from("rds_movimientos")
  .select("*")
  .eq("anio", selectedYear);

if (movsError) {
  console.error("Error rds_movimientos:", movsError.message);
}

const movimientos = (movsData ?? []) as MovimientoRds[];

// --- Cálculos agregados ---
interface PromoRds {
  id: string;
  anio: number;
  mes: number;
  importe: number;
}

// Gastos de promoción del año seleccionado
const { data: promoData, error: promoError } = await supabase
  .from("rds_promo")
  .select("*")
  .eq("anio", selectedYear);

if (promoError) {
  console.error("Error rds_promo:", promoError.message);
}

const promoByMes: Record<number, number> = {};
for (const row of (promoData ?? []) as PromoRds[]) {
  promoByMes[row.mes] = row.importe ?? 0;
}

// helper para mostrar decimales como ES
function formatMoneyEs(n: number): string {
  if (!Number.isFinite(n)) return "";
  return new Intl.NumberFormat("es-ES", {
	minimumFractionDigits: 2,
	maximumFractionDigits: 2,
  }).format(n);
}

function resumenGlobal(movs: MovimientoRds[]) {
  let totalGastos = 0;
  let totalIngresos = 0;
  let totalPromos = 0;

  for (const m of movs) {
	totalGastos += m.gasto ?? 0;
	totalIngresos += m.ingreso ?? 0;
	totalPromos += m.promocion ?? 0;
  }

  return { totalGastos, totalIngresos, totalPromos };
}

const resumen = resumenGlobal(movimientos);

function buildMesesResumen(movs: MovimientoRds[], anio: number) {
  const byMes: Record<number, { gastos: number; ingresos: number; promo: number }> = {};

  for (const m of movs) {
	if (m.anio !== anio) continue;
	if (!byMes[m.mes]) {
	  byMes[m.mes] = { gastos: 0, ingresos: 0, promo: 0 };
	}
	byMes[m.mes].gastos += m.gasto ?? 0;
	byMes[m.mes].ingresos += m.ingreso ?? 0;
	byMes[m.mes].promo += m.promocion ?? 0;
  }

  return Array.from({ length: 12 }, (_, idx) => {
	const mesNum = idx + 1;
	const base = byMes[mesNum] ?? { gastos: 0, ingresos: 0, promo: 0 };
	const balance = base.ingresos - base.gastos;
	const balanceAjustado = balance - base.promo;

	return {
	  mes: mesNum,
	  gastos: base.gastos,
	  ingresos: base.ingresos,
	  promocion: base.promo,
	  balance,
	  balanceAjustado,
	};
  });
}

const mesesResumen = buildMesesResumen(movimientos, selectedYear);

// Mapa: piso_id → resumen anual
function resumenPorPiso(movs: MovimientoRds[], anio: number) {
  const map: Record<string, { gastos: number; ingresos: number }> = {};

  for (const m of movs) {
	if (m.anio !== anio) continue;
	if (!map[m.piso_id]) {
	  map[m.piso_id] = { gastos: 0, ingresos: 0 };
	}
	map[m.piso_id].gastos += m.gasto ?? 0;
	map[m.piso_id].ingresos += m.ingreso ?? 0;
  }

  return map;
}

const resumenPisos = resumenPorPiso(movimientos, selectedYear);

// Mapa: piso_id → array de 12 meses solo para ese piso y año
function mesesPorPiso(pisoId: string) {
  const byMes: Record<number, { gasto: number; ingreso: number }> = {};

  for (const m of movimientos) {
	if (m.piso_id !== pisoId || m.anio !== selectedYear) continue;
	byMes[m.mes] = {
	  gasto: m.gasto ?? 0,
	  ingreso: m.ingreso ?? 0,
	};
  }

  return Array.from({ length: 12 }, (_, idx) => {
	const mesNum = idx + 1;
	const base = byMes[mesNum] ?? { gasto: 0, ingreso: 0 };
	const balance = base.ingreso - base.gasto;
	return {
	  mes: mesNum,
	  ...base,
	  balance,
	};
  });
}

const nombresMes = [
  "Ene", "Feb", "Mar", "Abr",
  "May", "Jun", "Jul", "Ago",
  "Sep", "Oct", "Nov", "Dic"
];
---

<Admin>
	<SectionHeader title="Gestión RDS" actionURL="/admin/rds/nuevo" />
	<section class="section-toolbar">
	  <form method="get" class="year-filter">
		<label for="year">Año</label>
		<select id="year" name="year">
		  {Array.from({ length: 6 }, (_, i) => {
			const y = currentYear - 2 + i;
			return (
			  <option value={y} selected={y === selectedYear}>
				{y}
			  </option>
			);
		  })}
		</select>
		<noscript>
		  <button type="submit">Aplicar</button>
		</noscript>
	  </form>
	</section>


	  <h2>Listado de pisos ({selectedYear})</h2>
	<section class="section-table rds-listado">
		<table class="table-full table-schema--light rds-table">
		  <thead>
			<tr>
			  <th>Piso</th>
			  <th>Gastos</th>
			  <th>Ingresos</th>
			  <th>Beneficio</th>
			  <th></th>
			</tr>
		  </thead>
		  <tbody>
			{pisos.map((piso) => {
			  const res = resumenPisos[piso.id];
		  
			  const tieneDatos = !!res;
			  const gastos = tieneDatos ? res.gastos : 0;
			  const ingresos = tieneDatos ? res.ingresos : 0;
			  const beneficio = ingresos - gastos;
		  
			  const mesesPiso = mesesPorPiso(piso.id);
		  
			  return (
				<>
				  <tr class={tieneDatos ? '' : 'rds-row-sin-datos'}>
					<td>
					  {piso.nombre}
					  <br />
					  {piso.direccion}
					</td>
					<td>{gastos.toFixed(2)}</td>
					<td>{ingresos.toFixed(2)}</td>
					<td>{beneficio.toFixed(2)}</td>
					{/* si ya no usas beneficio ajustado, puedes igualarlo al beneficio */}
					<td>{beneficio.toFixed(2)}</td>
					<td>
					  <a href={`/admin/rds/${piso.id}?year=${selectedYear}`}>Gestionar</a>
					</td>
				  </tr>
		  
				  <tr>
					<td colspan={6}>
					  <details>
						<summary>
						  Ver meses
						  {!tieneDatos && (
							<span class="rds-sin-datos-tag">
							  {' '}
							  · sin movimientos en {selectedYear}
							</span>
						  )}
						</summary>
		  
						<table class="rds-mini-meses">
						  <thead>
							<tr>
							  <th></th>
							  {mesesPiso.map((m) => (
								<th>{nombresMes[m.mes - 1]}</th>
							  ))}
							</tr>
						  </thead>
						  <tbody>
							<tr>
							  <th>Gasto</th>
							  {mesesPiso.map((m) => (
								<td>{m.gasto.toFixed(2)}</td>
							  ))}
							</tr>
							<tr>
							  <th>Ingreso</th>
							  {mesesPiso.map((m) => (
								<td>{m.ingreso.toFixed(2)}</td>
							  ))}
							</tr>
							<tr>
							  <th>Balance</th>
							  {mesesPiso.map((m) => (
								<td>{m.balance.toFixed(2)}</td>
							  ))}
							</tr>
						  </tbody>
						</table>
					  </details>
					</td>
				  </tr>
				</>
			  );
			})}
		  </tbody>
		</table>
	</section>
	<section class="rds-promo">
	  <h2>Gastos promoción ({selectedYear})</h2>
	  <p class="muted">
		Gastos globales de promoción, aplicados al año completo. No pertenecen a un piso concreto.
	  </p>
	
	  <form id="rds-promo-form">
		<input type="hidden" name="anio" value={selectedYear} />
	
		<table class="rds-mini-meses">
		  <thead>
			<tr>
			  <th></th>
			  {Array.from({ length: 12 }, (_, idx) => {
				const mes = idx + 1;
				return <th>{nombresMes[mes - 1]}</th>;
			  })}
			</tr>
		  </thead>
		  <tbody>
			<tr>
			  <th>Promoción</th>
			  {Array.from({ length: 12 }, (_, idx) => {
				const mes = idx + 1;
				const valor = promoByMes[mes] ?? 0;
				return (
				  <td>
					<input
					  type="text"
					  inputmode="decimal"
					  name={`mes_${mes}_promo`}
					  value={formatMoneyEs(valor)}
					/>
				  </td>
				);
			  })}
			</tr>
		  </tbody>
		</table>
		<table class="rds-mini-meses">
		  <thead>
			<tr>
			  <th></th>
			  {Array.from({ length: 12 }, (_, idx) => {
				const mes = idx + 1;
				return <th>{nombresMes[mes - 1]}</th>;
			  })}
			</tr>
		  </thead>
		  <tbody>
			<tr>
			  <th>Alquiler</th>
			  {Array.from({ length: 12 }, (_, idx) => {
				const mes = idx + 1;
				const valor = promoByMes[mes] ?? 0;
				return (
				  <td>
					<input
					  type="text"
					  inputmode="decimal"
					  name={`mes_${mes}_promo`}
					  value={formatMoneyEs(valor)}
					/>
				  </td>
				);
			  })}
			</tr>
		  </tbody>
		</table>
		<table class="rds-mini-meses">
		  <thead>
			<tr>
			  <th></th>
			  {Array.from({ length: 12 }, (_, idx) => {
				const mes = idx + 1;
				return <th>{nombresMes[mes - 1]}</th>;
			  })}
			</tr>
		  </thead>
		  <tbody>
			<tr>
			  <th>Derrama</th>
			  {Array.from({ length: 12 }, (_, idx) => {
				const mes = idx + 1;
				const valor = promoByMes[mes] ?? 0;
				return (
				  <td>
					<input
					  type="text"
					  inputmode="decimal"
					  name={`mes_${mes}_promo`}
					  value={formatMoneyEs(valor)}
					/>
				  </td>
				);
			  })}
			</tr>
		  </tbody>
		</table>
	
		<div class="form-actions">
		  <button type="submit" class="btn">Guardar promoción</button>
		</div>
		<p id="rds-promo-status" class="muted"></p>
	  </form>
	</section>
  </main>
</Admin>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
	const form = document.querySelector('.year-filter');
	if (!form) return;
	const select = form.querySelector('select[name="year"]');
	if (!select) return;

	select.addEventListener('change', () => {
	  form.submit();
	});
  });
  // --- Helpers dinero (igual estilo que en [id].astro) ---
	function normalizeMoneyLike(v) {
	  if (v == null) return "0";
	  let s = String(v).trim();
	  if (!s) return "0";
	  s = s.replace(/\s+/g, "");
	  const hasComma = s.includes(",");
	  if (hasComma) {
		s = s.replace(/\./g, "");
		const last = s.lastIndexOf(",");
		const intPart = s.slice(0, last).replace(/,/g, "");
		const decPart = s.slice(last + 1);
		s = intPart + (decPart ? "." + decPart : "");
	  } else {
		const last = s.lastIndexOf(".");
		if (last >= 0) {
		  const intPart = s.slice(0, last).replace(/\./g, "");
		  const decPart = s.slice(last + 1);
		  s = intPart + (decPart ? "." + decPart : "");
		}
	  }
	  if (!/^\d+(\.\d+)?$/.test(s)) return "0";
	  return s;
	}
  
	function toMoneyOrZero(v) {
	  const canon = normalizeMoneyLike(v);
	  if (canon == null) return 0;
	  const n = Number(canon);
	  if (!Number.isFinite(n)) return 0;
	  if (Math.trunc(Math.abs(n)) >= 1000000000) return 0;
	  return Number(n.toFixed(2));
	}
  
	// --- Formulario de gastos de promoción ---
	const promoForm = document.getElementById('rds-promo-form');
	const promoStatus = document.getElementById('rds-promo-status');
  
	function setPromoStatus(msg, isError) {
	  if (!promoStatus) return;
	  promoStatus.textContent = msg;
	  promoStatus.style.color = isError ? '#c00' : '#555';
	}
  
	if (promoForm) {
	  promoForm.addEventListener('submit', async (ev) => {
		ev.preventDefault();
		setPromoStatus('', false);
  
		const fd = new FormData(promoForm);
		const anioStr = fd.get('anio');
		const anio = Number(anioStr);
  
		if (!anio || !Number.isFinite(anio)) {
		  setPromoStatus('Error: año inválido.', true);
		  return;
		}
  
		const meses = [];
		for (let mes = 1; mes <= 12; mes++) {
		  const raw = fd.get(`mes_${mes}_promo`) || '0';
		  const importe = toMoneyOrZero(raw);
		  meses.push({ mes, importe });
		}
  
		try {
		  const resp = await fetch('/.netlify/functions/rds_promo_save', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({ anio, meses }),
		  });
  
		  if (!resp.ok) {
			const txt = await resp.text();
			throw new Error(txt || 'Error HTTP ' + resp.status);
		  }
  
		  const json = await resp.json();
		  if (json.error) {
			throw new Error(json.error);
		  }
  
		  setPromoStatus('Gastos de promoción guardados correctamente.', false);
		} catch (err) {
		  console.error('Error guardando gastos de promoción:', err);
		  setPromoStatus('Error al guardar gastos de promoción.', true);
		}
	  });
	}
</script>

