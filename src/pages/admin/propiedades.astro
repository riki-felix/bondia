---
import Admin from "../../components/Admin.astro";
import { formatEuro, toNum } from "../../../../lib/money";

export const prerender = false;
---
<Admin>
<header>
  <div>
	<h1 style="margin:.25rem 0 .25rem">Propiedades</h1>
  </div>
  <div class="topbar">
	<input id="q" type="search" placeholder="Buscar por tÃ­tulo, estado o slugâ€¦" />
	<div class="seg" id="tipo-seg" role="tablist" aria-label="Filtrar por tipo">
	  <button type="button" class="is-active" data-tipo="all" role="tab" aria-selected="true">Todas</button>
	  <button type="button" data-tipo="activos" role="tab" aria-selected="false">Activos</button>
	  <button type="button" data-tipo="inversion" role="tab" aria-selected="false">InversiÃ³n</button>
	</div>
	<a class="btn" href="/admin/nueva">+ Nueva</a>
  </div>
</header>

<p id="msg" class="status" style="display:none"></p>

<table>
  <thead>
	<tr>
	  <th>Imagen</th>
	  <th>TÃ­tulo</th>
	  <th>Estado</th>
	  <th class="hide-sm">Valor compra</th>
	  <th class="hide-sm">Creada</th>
	  <th style="width:1%">Acciones</th>
	</tr>
  </thead>
  <tbody id="rows">
	<tr><td colspan="6" class="muted">Cargandoâ€¦</td></tr>
  </tbody>
</table>

<script is:inline type="module">
  import { supabase } from '/src/scripts/supabaseClient.js';

  // ðŸ”¹ Usa el nombre real del bucket
  const DEFAULT_BUCKET = 'property-image'; // <-- aquÃ­ el singular

  const rowsEl = document.getElementById('rows');
  const msgEl  = document.getElementById('msg');
  const qEl    = document.getElementById('q');
  const segEl  = document.getElementById('tipo-seg');
  const userEmailEl = document.getElementById('user-email');

  let allRows = [];
  let user = null;
  let tipoFilter = 'all';

  const fmtDate = (iso) => {
	if (!iso) return '';
	try {
	  const d = new Date(iso);
	  return d.toLocaleDateString('es-ES', { year:'numeric', month:'2-digit', day:'2-digit' });
	} catch { return iso; }
  };

  const fmtMoney = (n) => {
	if (n === null || n === undefined || n === '') return '';
	const num = Number(n);
	if (!Number.isFinite(num)) return String(n);
	return num.toLocaleString('es-ES', { style:'currency', currency:'EUR' });
  };

  const setMsg = (text, kind = 'ok') => {
	msgEl.textContent = text;
	msgEl.className = 'status ' + kind;
	msgEl.style.display = 'block';
	if (kind === 'ok') setTimeout(() => (msgEl.style.display = 'none'), 2000);
  };

  const badgeClass = (estado) => {
	const s = (estado || '').toLowerCase();
	if (['activa','publicada','en venta','disponible'].includes(s)) return 'ok';
	if (['borrador','pendiente','en revisiÃ³n'].includes(s)) return 'neutral';
	if (['reservada','pausada'].includes(s)) return 'warn';
	if (['vendida','archivada','eliminada'].includes(s)) return 'err';
	return 'neutral';
  };

  const normalize = (str='') =>
	str.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();

  const matchTipo = (valorTipo) => {
	if (tipoFilter === 'all') return true;
	const t = normalize(valorTipo);
	if (tipoFilter === 'activos')   return t === 'activo' || t === 'activos';
	if (tipoFilter === 'inversion') return t === 'inversion' || t === 'de inversion';
	return true;
  };

  // ðŸ–¼ï¸ Resolver URL de imagen desde `foto_destacada_path`
  async function resolveImageUrl(rawPath) {
	if (!rawPath) return '';

	// Si ya es una URL completa, devolver tal cual
	if (/^https?:\/\//.test(rawPath)) return rawPath;

	// Permitir que el path venga con "bucket/path/to/file"
	// o sÃ³lo "path/to/file"
	let bucket = DEFAULT_BUCKET;
	let path = rawPath;

	const firstSlash = rawPath.indexOf('/');
	if (firstSlash > 0 && !rawPath.startsWith('public/')) {
	  // HeurÃ­stica: si el prefijo parece ser el nombre del bucket real
	  const maybeBucket = rawPath.slice(0, firstSlash);
	  const rest = rawPath.slice(firstSlash + 1);
	  // buckets tÃ­picos que hemos usado: property-image, property-images
	  if (['property-image', 'property-images', 'propiedades'].includes(maybeBucket)) {
		bucket = maybeBucket;
		path = rest;
	  }
	}

	// 1) Intentar URL pÃºblica directa
	const pub = supabase.storage.from(bucket).getPublicUrl(path);
	if (pub?.data?.publicUrl) return pub.data.publicUrl;

	// 2) Si el bucket es privado, generar una URL firmada
	try {
	  const { data, error } = await supabase.storage.from(bucket).createSignedUrl(path, 3600); // 1h
	  if (!error && data?.signedUrl) return data.signedUrl;
	} catch {}

	return '';
  }

  const render = (list) => {
	if (!Array.isArray(list) || list.length === 0) {
	  rowsEl.innerHTML = '<tr><td colspan="6" class="muted">No hay propiedades todavÃ­a.</td></tr>';
	  return;
	}
	rowsEl.innerHTML = list.map((r) => {
	  const viewHref = r.slug ? `/propiedad/${encodeURIComponent(r.slug)}` : `/propiedad/${r.id}`;
	  const editHref = r.slug ? `/admin/propiedad/${encodeURIComponent(r.slug)}/editar` : '';

	  const img = r._img
		? `<img class="thumb" src="${r._img}" alt="">`
		: '<div class="thumb" style="border:1px solid #eee"></div>';

	  const editBtn = editHref
		? `<a class="btn" href="${editHref}">Editar</a>`
		: `<button class="btn" disabled title="Falta slug">Editar</button>`;

	  return `
		<tr data-id="${r.id}" data-slug="${r.slug || ''}">
		  <td>${img}</td>
		  <td><a href="${viewHref}">${r.titulo || '(sin tÃ­tulo)'}</a></td>
		  <td><span class="badge ${badgeClass(r.estado)}">${r.estado || 'â€”'}</span></td>
		  <td class="hide-sm val">${fmtMoney(r.precio_compra)}</td>
		  <td class="hide-sm">${fmtDate(r.created_at)}</td>
		  <td><div class="actions">${editBtn}</div></td>
		</tr>
	  `;
	}).join('');
  };

  const applyFilters = () => {
	const q = qEl.value.trim().toLowerCase();
	const list = allRows.filter(r => {
	  const matchesSearch =
		!q ||
		(r.titulo || '').toLowerCase().includes(q) ||
		(r.estado || '').toLowerCase().includes(q) ||
		(r.slug || '').toLowerCase().includes(q);
	  const matchesTipo = matchTipo(r.tipo || '');
	  return matchesSearch && matchesTipo;
	});
	render(list);
  };

  const load = async () => {
	// include `tipo` para el switch
	const { data, error } = await supabase
	  .from('propiedades')
	  .select('id, slug, titulo, estado, tipo, precio_compra, foto_destacada_path, created_at')
	  .order('created_at', { ascending: false })
	  .limit(200);

	if (error) {
	  rowsEl.innerHTML = '<tr><td colspan="6" class="muted">Error cargando propiedades.</td></tr>';
	  setMsg('âŒ ' + error.message, 'err');
	  return;
	}

	// ðŸ”¹ Resolver URLs de imagen de forma asÃ­ncrona (pÃºblica o firmada)
	const withImg = await Promise.all(
	  (data || []).map(async (r) => ({
		...r,
		_img: await resolveImageUrl(r.foto_destacada_path)
	  }))
	);

	allRows = withImg;
	applyFilters();
  };

  // bÃºsqueda + switch
  qEl.addEventListener('input', applyFilters);
  segEl.addEventListener('click', (e) => {
	const btn = e.target.closest('button[data-tipo]');
	if (!btn) return;
	tipoFilter = btn.dataset.tipo;
	[...segEl.querySelectorAll('button')].forEach(b=>{
	  b.classList.toggle('is-active', b === btn);
	  b.setAttribute('aria-selected', b === btn ? 'true' : 'false');
	});
	applyFilters();
  });

  load();
</script>
</Admin>