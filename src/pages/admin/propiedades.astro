---
import "../../styles/components/section-toolbar.css";
import "../../styles/components/tables.css";
import Admin from "../../components/Admin.astro";
import SectionHeader from "../../components/SectionHeader.astro";
import { formatEuro, toNum } from "../../lib/money";

export const prerender = false;
---
<Admin>
  <SectionHeader title="Gestionar Pisos" actionURL="/admin/nueva"/>

  <section class="section-toolbar">
	<input id="q" type="search" placeholder="Buscar por título, estado o slug…" />
	<div class="seg" id="tipo-seg" role="tablist" aria-label="Filtrar por tipo">
	  <button type="button" class="is-active" data-tipo="all" role="tab" aria-selected="true">Todas</button>
	  <button type="button" data-tipo="activos" role="tab" aria-selected="false">Activos</button>
	  <button type="button" data-tipo="inversion" role="tab" aria-selected="false">Inversión</button>
	</div>
  </section>

  <p id="status" class="status" style="display:none"></p>

  <section class="section-table">
	<table class="table-full table-schema--light">
	  <thead>
		<tr>
		  <th>Nº op.</th>
		  <th>Título</th>
		  <th>Estado</th>
		  <th>Inicio</th>
		  <th>Pago</th>
		  <th>Aportación</th>
		  <th>Retribución</th>
		  <th>Retención</th>
		  <th>Ingreso</th>
		  <th>Fecha ingreso</th>
		  <th>Efectivo</th>
		  <th>JASP</th>
		  <th>Liquidación</th>
		  <th>Fecha compra</th>
		  <th>Fecha venta</th>
		  <th>Ocupado</th>
		  <th>Notas</th>
		  <th style="width:1%">Acciones</th>
		</tr>
	  </thead>
	  <tbody id="rows">
		<tr><td colspan="10" class="muted">Cargando…</td></tr>
	  </tbody>
	</table>
  </section>
  <style>
	/* 1) El contenedor debe scrollear */
	.section-table {
	  max-height: calc(100vh - 260px); /* ajusta según tu layout */
	  overflow: auto;
	  border-radius: 12px; /* opcional */
	}
  
	/* 2) Sticky header */
	.section-table table thead th {
	  position: sticky;
	  top: 0;
	  z-index: 5;            /* para estar por encima de las celdas */
	  background: white;     /* IMPORTANTÍSIMO (si no, se transparenta) */
	  box-shadow: 0 1px 0 rgba(0,0,0,.08); /* línea inferior */
	}
  
	/* 3) Si tienes celdas con background/hover, esto evita glitches */
	.section-table table {
	  border-collapse: separate;
	  border-spacing: 0;
	}
  </style>
  <script type="module" define:vars={{
	SUPABASE_URL: import.meta.env.PUBLIC_SUPABASE_URL,
	SUPABASE_ANON_KEY: import.meta.env.PUBLIC_SUPABASE_ANON_KEY
  }}>
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  const rowsEl = document.getElementById('rows');
  const qEl = document.getElementById('q');
  const segEl = document.getElementById('tipo-seg');
  const msgEl = document.getElementById('status');
  
  var allRows = [];
  var tipoFilter = 'all';
  
  function setMsg(text, kind) {
	msgEl.textContent = text;
	msgEl.className = 'status ' + (kind || 'ok');
	msgEl.style.display = 'block';
	if ((kind || 'ok') === 'ok') {
	  setTimeout(function() { msgEl.style.display = 'none'; }, 2500);
	}
  }
  
  function fmtDate(iso) {
	if (!iso) return '—';
	try {
	  const date = new Date(iso);
	  return date.toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' });
	} catch (e) {
	  return String(iso);
	}
  }
  
  function fmtMoney(value) {
	if (value == null) return '—';
	return parseFloat(value).toLocaleString('es-ES', { style: 'currency', currency: 'EUR' });
  }
  
  function badgeClass(estado) {
	const s = String(estado || '').toLowerCase();
	if (['vendido'].includes(s)) return 'err';
	if (['alquiler'].includes(s)) return 'ok';
	if (['reforma', 'comprado', 'negociacion', 'tanteo'].includes(s)) return 'neutral';
	return 'neutral';
  }
  
  function render(list) {
	if (!Array.isArray(list) || list.length === 0) {
	  rowsEl.innerHTML = '<tr><td colspan="17" class="muted">No hay datos para mostrar.</td></tr>';
	  return;
	}
  
	rowsEl.innerHTML = list.map(function(row) {
	  return `
		<tr data-id="${row.id}">
		  <td>${row.numero_operacion || '—'}</td>
		  <td>${row.titulo || '—'}</td>
		  <td><span class="badge ${badgeClass(row.estado)}">${row.estado || '—'}</span></td>
		  <td>${fmtDate(row.created_at)}</td>
		  <td>${row.pago ? 'Sí' : 'No'}</td>
		  <td>${fmtMoney(row.aportacion)}</td>
		  <td>${fmtMoney(row.retribucion)}</td>
		  <td>${fmtMoney(row.retencion)}</td>
		  <td>${fmtMoney(row.ingreso_banco)}</td>
		  <td>${fmtDate(row.fecha_ingreso)}</td>
		  <td>${fmtMoney(row.efectivo)}</td>
		  <td>${fmtMoney(row.jasp_10_percent)}</td>
		  <td>${row.liquidacion ? 'Sí' : 'No'}</td>
		  <td>${fmtDate(row.fecha_compra)}</td>
		  <td>${fmtDate(row.fecha_venta)}</td>
		  <td>${row.ocupado ? 'Sí' : 'No'}</td>
		  <td>${row.notas || '—'}</td>
		  <td style="text-align: center">
			<a href="/admin/edit/${row.id}" class="btn">Editar</a>
		  </td>
		</tr>`;
	}).join('');
  }
  
  async function loadData() {
	const { data, error } = await supabase
	  .from('propiedades')
	  .select('id, titulo, estado, created_at, pago, aportacion, retribucion, retencion, ingreso_banco, fecha_ingreso, efectivo, jasp_10_percent, liquidacion, fecha_compra, fecha_venta, ocupado, notas, numero_operacion')
	  .order('numero_operacion', { ascending: true });
  
	if (error) {
	  console.error('Error loading data:', error);
	  rowsEl.innerHTML = '<tr><td colspan="17" class="muted">Error al cargar datos.</td></tr>';
	  setMsg('❌ ' + error.message, 'err');
	  return;
	}
  
	allRows = data || [];
	applyFilters();
  }
  
  function applyFilters() {
	const query = qEl.value.toLowerCase();
	const filteredRows = allRows.filter(row => {
	  return (
		(!query || 
		  row.titulo?.toLowerCase().includes(query) || 
		  row.estado?.toLowerCase().includes(query) || 
		  (String(row.numero_operacion || '')).toLowerCase().includes(query)
		) 
		&& (tipoFilter === 'all' || row.tipo === tipoFilter)
	  );
	});
  
	render(filteredRows);
  }
  
  // Handle search input
  qEl.addEventListener('input', applyFilters);
  
  // Handle filter by type
  segEl.addEventListener('click', function(event) {
	const button = event.target.closest('button[data-tipo]');
	if (!button) return;
  
	tipoFilter = button.dataset.tipo;
  
	Array.from(segEl.querySelectorAll('button')).forEach(btn => {
	  btn.classList.toggle('is-active', btn === button);
	  btn.setAttribute('aria-selected', btn === button);
	});
  
	applyFilters();
  });
  
  loadData();
  </script>
</Admin>