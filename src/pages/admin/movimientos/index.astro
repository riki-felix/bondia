---
export const prerender = false;

import Admin from "../../../components/Admin.astro";
import { supabaseServer } from "../../../lib/supabaseServer";

const { data: fechas, error } = await supabaseServer()
  .from("movimientos")
  .select("fecha")
  .not("fecha", "is", null);

const yearSet = new Set<number>();
if (fechas) {
  for (const row of fechas) {
	if (!row.fecha) continue;
	const d = new Date(row.fecha as string);
	if (!Number.isNaN(d.getTime())) yearSet.add(d.getFullYear());
  }
}
const years = Array.from(yearSet).sort((a, b) => b - a);
const currentYear = new Date().getFullYear();
---

<Admin title="Movimientos">
  <header class="main-header">
	<h1>Movimientos</h1>
	<div class="page-actions">
	  <a class="button--small" href="/admin/movimientos/nuevo">+ Nuevo</a>
	</div>
  </header>

  {error && (
	<p class="error">
	  Error cargando años de movimientos: {error.message}
	</p>
  )}

  <!-- Filtros: año + ámbito + buscador -->
  <form
	id="mov-filters"
	class="mov-filters"
	onsubmit="return false;"
  >
	<div class="mov-filter-field">
	  <label for="mov-year" class="mov-label">Año</label>
	  <select id="mov-year" name="year" class="mov-select">
		<option value="">Todos</option>
		{years.map((y) => (
		  <option value={y} selected={y === currentYear}>
			{y}
		  </option>
		))}
	  </select>
	</div>

	<div class="mov-filter-field">
	  <label for="mov-ambito" class="mov-label">Ámbito</label>
	  <select id="mov-ambito" name="ambito" class="mov-select">
		<option value="">Todos</option>
		<option value="inversion">Inversión</option>
		<option value="casa">Casa</option>
		<option value="otro">Otro</option>
	  </select>
	</div>

	<div class="mov-filter-field mov-filter-search">
	  <label for="mov-search" class="mov-label">Buscar por concepto</label>
	  <input
		id="mov-search"
		name="q"
		type="search"
		placeholder="Ej. arras, comunidad, precarios…"
		class="mov-input"
	  />
	</div>
  </form>

  <div id="mov-list-wrap">
	<table id="mov-table" class="mov-table">
	  <thead>
		<tr>
		  <th>Fecha</th>
		  <th>Concepto</th>
		  <th>Propiedad</th>
		  <th class="text-right">Importe</th>
		  <th>Tipo</th>
		  <th>Autor</th>
		  <th>Ámbito</th>
		  <th class="text-right">Acciones</th>
		</tr>
	  </thead>
	  <tbody>
		<!-- Se rellena por JS -->
	  </tbody>
	</table>

	<div class="mov-footer">
	  <button
		id="mov-load-more"
		type="button"
		class="mov-load-btn"
	  >
		Cargar más
	  </button>
	  <span id="mov-status" class="mov-status"></span>
	</div>
  </div>
</Admin>

<script is:inline>
  const tableBody   = document.querySelector("#mov-table tbody");
  const loadMoreBtn = document.getElementById("mov-load-more");
  const statusEl    = document.getElementById("mov-status");

  const yearSelect   = document.getElementById("mov-year");
  const ambitoSelect = document.getElementById("mov-ambito");
  const searchInput  = document.getElementById("mov-search");

  const limit = 100;
  let offset = 0;
  let total  = 0;
  let loading = false;

  let currentYear   = yearSelect?.value || "";
  let currentAmbito = ambitoSelect?.value || "";
  let currentQuery  = "";

  const moneyFmt = new Intl.NumberFormat("es-ES", {
	style: "currency",
	currency: "EUR",
  });

  function formatMoney(v) {
	if (v == null || v === "") return "—";
	const n = Number(v);
	if (!Number.isFinite(n)) return String(v);
	return moneyFmt.format(n);
  }

  function formatDate(iso) {
	if (!iso) return "—";
	const d = new Date(iso);
	if (Number.isNaN(d.getTime())) return iso;
	return d.toLocaleDateString("es-ES");
  }

  function renderRows(rows, { append = false } = {}) {
	if (!append) {
	  tableBody.innerHTML = "";
	}

	if (!rows.length && !append) {
	  tableBody.innerHTML = `
		<tr>
		  <td colspan="8" class="muted">No hay movimientos para este filtro.</td>
		</tr>
	  `;
	  return;
	}

	for (const m of rows) {
	  const tr = document.createElement("tr");

	  const fecha = formatDate(m.fecha);
	  const concepto = m.concepto || "—";
	  const propTitulo = m.propiedad_titulo || "—";
	  const importe = formatMoney(m.importe);
	  const tipo = m.tipo_movimiento || "—";
	  const autor = m.autor || "—";
	  const ambito = m.ambito || "—";
	  const slug = m.slug || m.id;

	  tr.innerHTML = `
		<td>${fecha}</td>
		<td> <a href="/admin/movimientos/${m.id}/editar">${concepto}</a></td>
		<td>${propTitulo}</td>
		<td class="text-right">${importe}</td>
		<td>${tipo}</td>
		<td>${autor}</td>
		<td>${ambito}</td>
		<td class="text-right">
		  <a href="/admin/movimientos/${m.id}/editar">Editar</a>
		</td>
	  `;
	  tableBody.appendChild(tr);
	}
  }

  function updateStatus() {
	if (!statusEl) return;
	if (total === 0) {
	  statusEl.textContent = "0 resultados";
	  return;
	}
	const shown = Math.min(offset, total);
	statusEl.textContent = `${shown} de ${total}`;
  }

  function updateLoadMore(hasMore) {
	if (!loadMoreBtn) return;
	loadMoreBtn.style.display = hasMore ? "inline-flex" : "none";
	loadMoreBtn.disabled = !hasMore || loading;
  }

  async function fetchMovements({ reset = false } = {}) {
	if (loading) return;
	loading = true;
	if (loadMoreBtn) loadMoreBtn.disabled = true;

	if (reset) {
	  offset = 0;
	  total = 0;
	  renderRows([], { append: false });
	  updateStatus();
	}

	try {
	  const params = new URLSearchParams();
	  params.set("limit", String(limit));
	  params.set("offset", String(offset));
	  if (currentYear)   params.set("year", currentYear);
	  if (currentQuery)  params.set("q", currentQuery);
	  if (currentAmbito) params.set("ambito", currentAmbito);

	  const res = await fetch(`/.netlify/functions/listMovements?${params.toString()}`);
	  const txt = await res.text();
	  let out; try { out = JSON.parse(txt); } catch { out = {}; }

	  if (!res.ok) {
		console.error("[movimientos] error:", out);
		if (!offset) {
		  tableBody.innerHTML = `
			<tr>
			  <td colspan="8" class="muted">
				Error cargando movimientos.
			  </td>
			</tr>
		  `;
		}
		return;
	  }

	  const rows = Array.isArray(out.data) ? out.data : [];
	  total = typeof out.count === "number" ? out.count : (offset + rows.length);
	  const hasMore = !!out.hasMore;

	  renderRows(rows, { append: !reset });
	  offset += rows.length;
	  updateStatus();
	  updateLoadMore(hasMore);
	} catch (err) {
	  console.error("[movimientos] fetchMovements error:", err);
	  if (!offset) {
		tableBody.innerHTML = `
		  <tr>
			<td colspan="8" class="muted">
			  Error inesperado cargando movimientos.
			</td>
		  </tr>
		`;
	  }
	} finally {
	  loading = false;
	  if (loadMoreBtn) loadMoreBtn.disabled = false;
	}
  }

  // Eventos filtros
  yearSelect?.addEventListener("change", () => {
	currentYear = yearSelect.value;
	fetchMovements({ reset: true });
  });

  ambitoSelect?.addEventListener("change", () => {
	currentAmbito = ambitoSelect.value;
	fetchMovements({ reset: true });
  });

  let searchTimeout;
  searchInput?.addEventListener("input", () => {
	const val = searchInput.value.trim();
	currentQuery = val;
	if (searchTimeout) clearTimeout(searchTimeout);
	searchTimeout = setTimeout(() => {
	  fetchMovements({ reset: true });
	}, 300);
  });

  loadMoreBtn?.addEventListener("click", () => {
	fetchMovements({ reset: false });
  });

  document.addEventListener("DOMContentLoaded", () => {
	currentYear   = yearSelect?.value || "";
	currentAmbito = ambitoSelect?.value || "";
	currentQuery  = searchInput?.value?.trim() || "";
	fetchMovements({ reset: true });
  });
</script>

<style>
.mov-table {}
  .mov-filters {
	display: flex;
	flex-wrap: wrap;
	gap: 0.75rem;
	align-items: flex-end;
	margin-bottom: 1rem;
  }

  .mov-filter-field {
	display: flex;
	flex-direction: column;
	gap: 0.25rem;
  }

  .mov-filter-search {
	flex: 1;
	min-width: 200px;
  }

  .mov-label {
	font-size: 0.85rem;
	color: #555;
  }

  .mov-select,
  .mov-input {
	padding: 0.25rem 0.4rem;
	border-radius: 0.35rem;
	border: 1px solid #ccc;
	font-size: var(--font-size--s);
  }

  .mov-table {
	width: 100%;
	border-collapse: collapse;
	font-size: var(--font-size--s);
	font-family: var(--font-data-family);
  }

  .mov-table th,
  .mov-table td {
	border-bottom: 1px solid #ddd;
	padding: 0.4rem 0.2rem;
	text-align: left;
  }

  .mov-table th.text-right,
  .mov-table td.text-right {
	text-align: right;
  }

  .mov-footer {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-top: 0.75rem;
  }

  .mov-load-btn {
	padding: 0.45rem 0.85rem;
	border-radius: 0.45rem;
	border: 1px solid #ccc;
	background: #f7f7f7;
	font-size: 0.85rem;
	cursor: pointer;
  }

  .mov-status {
	font-size: 0.8rem;
	color: #666;
  }

  .muted {
	text-align: center;
	font-size: 0.85rem;
	color: #777;
  }

  .error {
	color: #b00020;
	font-size: var(--font-size--s);
  }
</style>