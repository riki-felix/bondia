---
export const prerender = false;
import Admin from "../../../components/Admin.astro";
---

<Admin title="Categorías de movimientos">
  <section style="max-width:740px;">
	<h1>Categorías</h1>

	<form id="new-cat" style="display:flex; gap:.5rem; margin:.75rem 0;">
	  <input id="cat-name" placeholder="Nombre de categoría" required />
	  <button type="submit">Crear</button>
	</form>

	<ul id="cat-list" style="display:grid; gap:.5rem;"></ul>
	<p id="cat-msg"></p>
  </section>
</Admin>

<script type="module">
  const list = document.getElementById('cat-list');
  const msg  = document.getElementById('cat-msg');

  await reload();

  document.getElementById('new-cat')?.addEventListener('submit', async (e) => {
	e.preventDefault();
	const name = document.getElementById('cat-name').value.trim();
	if (!name) return;
	const res = await fetch('/.netlify/functions/createMovCategory', {
	  method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ nombre: name })
	});
	if (!res.ok) { msg.textContent = 'Error creando'; msg.style.color = 'red'; return; }
	(document.getElementById('cat-name')).value = '';
	await reload();
  });

  async function reload() {
	msg.textContent = '';
	const res = await fetch('/.netlify/functions/listMovCategories');
	const out = await res.json();
	if (!res.ok) {
	  msg.textContent = `Error cargando: ${out.error || res.status}`;
	  msg.style.color = 'red';
	  return;
	}
	list.innerHTML = out.map(c => item(c)).join('');
	bind();
  }

  function item(c) {
	return `<li data-id="${c.id}" style="display:flex; gap:.5rem; align-items:center;">
	  <input class="edit-name" value="${escapeHtml(c.nombre)}" />
	  <button class="save">Guardar</button>
	  <button class="del" data-id="${c.id}" style="background:#b00020;color:white;">Borrar</button>
	  <small style="opacity:.6">slug: ${c.slug}</small>
	</li>`;
  }
  function bind() {
	list.querySelectorAll('.save').forEach(btn => btn.addEventListener('click', async (e) => {
	  const li = e.target.closest('li'); const id = li.dataset.id;
	  const nombre = li.querySelector('.edit-name').value.trim();
	  const res = await fetch('/.netlify/functions/updateMovCategory', {
		method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id, nombre })
	  });
	  if (!res.ok) { alert('Error guardando'); return; }
	  await reload();
	}));
	list.querySelectorAll('.del').forEach(btn => btn.addEventListener('click', async (e) => {
	  const id = e.target.dataset.id;
	  if (!confirm('¿Borrar categoría?')) return;
	  const res = await fetch('/.netlify/functions/deleteMovCategory', {
		method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id })
	  });
	  const ok = res.ok;
	  const out = await res.text();
	  if (!ok) { alert(out); return; }
	  await reload();
	}));
  }
  function escapeHtml(s){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}
</script>