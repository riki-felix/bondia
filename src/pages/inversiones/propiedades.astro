---
export const prerender = false;
import CountWidget from "../../widgets/CountWidget.astro";
import SumWidget from "../../widgets/SumWidget.astro";

import '../../../src/styles/pages/propiedades.css';

import Layout from "../../components/Layout.astro";
import { supabaseClient } from "../../lib/supabaseClient";
import { publicImageUrl } from '../../lib/imageUrl';
import { supabaseServer } from "../../lib/supabaseServer";
import { formatEuro } from "../../lib/money";

const supabase = supabaseClient();
const { data: properties, error } = await supabase
  .from("propiedades")
  .select("id, slug, titulo, superficie_m2, estado, fecha_compra, precio_compra, precio_venta, foto_destacada_path")
  .eq("tipo", "inversion")
  .order("created_at", { ascending: false });

const imgUrl = (p: any) =>
  p?.foto_destacada_path
	? `${import.meta.env.PUBLIC_SUPABASE_URL}/storage/v1/object/public/property-images/${p.foto_destacada_path}`
	: null;

// Años y estados únicos para filtros
let years: number[] = [];
let estados: string[] = [];

if (properties) {
  const yearSet = new Set<number>();
  const estadoSet = new Set<string>();

  for (const p of properties) {
	if (p.fecha_compra) {
	  const d = new Date(p.fecha_compra as string);
	  if (!Number.isNaN(d.getTime())) {
		yearSet.add(d.getFullYear());
	  }
	}
	if (p.estado) {
	  estadoSet.add(p.estado as string);
	}
  }

  years = Array.from(yearSet).sort((a, b) => b - a);
  estados = Array.from(estadoSet).sort((a, b) =>
	a.localeCompare(b, "es", { sensitivity: "base" })
  );
}

const fmtDate = (dateStr?: string | null): string => {
  if (!dateStr) return "";
  const d = new Date(dateStr);
  if (Number.isNaN(d.getTime())) return "";
  return d.toLocaleDateString("es-ES", {
	day: "2-digit",
	month: "short",
	year: "numeric",
  });
};
---

<Layout title="Inversiones">
  <header class="main-header">
	<h1>Inversiones</h1>
	<div class="page-actions">
	  <a class="button--small" href="/admin/nueva">+ Nueva</a>
	</div>
  </header>

  {error && <p>❌ {error.message}</p>}

  {(!error && (!properties || properties.length === 0)) && (
	<p>No hay propiedades de tipo <em>Inversión</em>.</p>
  )}

  {properties && properties.length > 0 && (
	<>
	  {/* Filtros */}
	  <section class="prop-filters">
		<div class="prop-filters__row">
		  <div class="prop-filter">
			<label for="prop-search" class="prop-filter__label">Buscar</label>
			<input
			  id="prop-search"
			  type="search"
			  placeholder="Ej. Pedraforca, París 68…"
			  class="prop-filter__input prop-filter__input--search"
			/>
		  </div>

		  <div class="prop-filter">
			<label for="prop-year" class="prop-filter__label">Año compra</label>
			<select id="prop-year" class="prop-filter__select">
			  <option value="">Todos</option>
			  {years.map((y) => (
				<option value={y}>{y}</option>
			  ))}
			</select>
		  </div>

		  <div class="prop-filter">
			<label for="prop-estado" class="prop-filter__label">Estado</label>
			<select id="prop-estado" class="prop-filter__select">
			  <option value="">Todos</option>
			  {estados.map((e) => (
				<option value={e}>{e}</option>
			  ))}
			</select>
		  </div>
		</div>
	  </section>

	  {/* Cards */}
	  <div class="cards-grid">
		{properties.map((p: any) => {
		  const fallback =
			"https://zcezehuuxkravxjfdrbm.supabase.co/storage/v1/object/public/property-images/b73d9021-c747-45af-888a-e6caaddda308/1762017591772_casa_2.png";

		  const src = imgUrl(p) || fallback;

		  const year =
			p.fecha_compra && !Number.isNaN(new Date(p.fecha_compra as string).getTime())
			  ? new Date(p.fecha_compra as string).getFullYear()
			  : "";

		  const estado = (p.estado || "") as string;

		  const searchText = [
			p.titulo || "",
			estado,
			year ? String(year) : "",
		  ]
			.join(" ")
			.toLowerCase();

		  return (
			<div
			  class="card-item"
			  data-year={year}
			  data-estado={estado.toLowerCase()}
			  data-search={searchText}
			>
			  {src && (
				<a class="card-img--link" href={`/propiedad/${p.slug}`}>
				  <img src={src} alt={p.titulo} loading="lazy" />
				</a>
			  )}

			  <h2 class="card-title">
				<a class="card-link" href={`/propiedad/${p.slug}`}>{p.titulo}</a>
			  </h2>

			  <p class="card-meta">
				Compra: {p.precio_compra ? formatEuro(p.precio_compra) : ''}<br />
				Venta: {p.precio_venta ? formatEuro(p.precio_venta) : ''}<br />
				{p.superficie_m2 ? `${p.superficie_m2} m²` : ''}<br />
				{p.estado ? `${p.estado}` : ''}
			  </p>
			</div>
		  );
		})}
	  </div>
	</>
  )}
</Layout>

<script type="module" is:inline>
  const searchInput = document.getElementById('prop-search');
  const yearSelect = document.getElementById('prop-year');
  const estadoSelect = document.getElementById('prop-estado');
  const cards = Array.from(document.querySelectorAll('.card-item'));

  function applyFilters() {
	const q = (searchInput?.value || '').trim().toLowerCase();
	const year = yearSelect?.value || '';
	const estado = (estadoSelect?.value || '').toLowerCase();

	for (const card of cards) {
	  const el = card;
	  const cardYear = el.getAttribute('data-year') || '';
	  const cardEstado = (el.getAttribute('data-estado') || '').toLowerCase();
	  const searchText = (el.getAttribute('data-search') || '').toLowerCase();

	  let show = true;

	  if (q && !searchText.includes(q)) show = false;
	  if (year && cardYear !== year) show = false;
	  if (estado && cardEstado !== estado) show = false;

	  el.style.display = show ? '' : 'none';
	}
  }

  let searchTimeout;
  searchInput?.addEventListener('input', () => {
	clearTimeout(searchTimeout);
	searchTimeout = setTimeout(applyFilters, 200);
  });

  yearSelect?.addEventListener('change', applyFilters);
  estadoSelect?.addEventListener('change', applyFilters);

  // Primera pasada
  applyFilters();
</script>

<style>
  .prop-filters {
	margin-bottom: 1rem;
  }
  .prop-filters__row {
	display: flex;
	flex-wrap: wrap;
	gap: 0.75rem;
	align-items: flex-end;
  }
  .prop-filter {
	display: flex;
	flex-direction: column;
	gap: 0.25rem;
	min-width: 180px;
  }
  .prop-filter__label {
	color: #555;
  }
  .prop-filter__input,
  .prop-filter__select {
	padding: 0.35rem 0.45rem;
	border-radius: 0.35rem;
	border: 1px solid #ccc;
  }
  .prop-filter__input--search {
	  min-width: 40.0rem;
  }
</style>