---
export const prerender = false;

import Layout from "../../components/Layout.astro";
import SectionHeader from "../../components/SectionHeader.astro";
import RdsCountWidget from "../../widgets/rds/RdsCountWidget.astro";
import RdsTotalsWidget from "../../widgets/rds/RdsTotalsWidget.astro";
import RdsCalendarWidget from "../../widgets/rds/RdsCalendarWidget.astro";
import { createSupabaseServerClient } from "../../lib/supabaseServer";
import "../../../src/styles/components/tables.css";
import "../../../src/styles/components/section-toolbar.css";


interface PisoRds {
  id: string;
  nombre: string;
  direccion?: string;
  fecha_creacion: string;
}

interface MovimientoRds {
  id: string;
  piso_id: string;
  anio: number;
  mes: number;
  gasto: number;
  ingreso: number;
  // existe en DB pero NO lo usamos aquí:
  promocion: number;
}

interface PromoRds {
  id: string;
  anio: number;
  mes: number;
  importe: number;
}

const url = Astro.url;
const now = new Date();
const currentYear = now.getFullYear();
const selectedYear = Number(url.searchParams.get("year") ?? currentYear);

const supabase = createSupabaseServerClient(Astro.cookies, Astro.request);

// --- Pisos ---
const { data: pisosData, error: pisosError } = await supabase
  .from("rds_pisos")
  .select("*")
  .order("fecha_creacion", { ascending: true });

if (pisosError) {
  console.error("Error rds_pisos (front):", pisosError.message);
}

const pisos = (pisosData ?? []) as PisoRds[];

// --- Movimientos del año seleccionado ---
const { data: movsData, error: movsError } = await supabase
  .from("rds_movimientos")
  .select("*")
  .eq("anio", selectedYear);

if (movsError) {
  console.error("Error rds_movimientos (front):", movsError.message);
}

const movimientos = (movsData ?? []) as MovimientoRds[];

// --- Promos globales del año seleccionado ---
const { data: promoData, error: promoError } = await supabase
  .from("rds_promo")
  .select("*")
  .eq("anio", selectedYear);

if (promoError) {
  console.error("Error rds_promo (front):", promoError.message);
}

const promos = (promoData ?? []) as PromoRds[];

// --- Helpers de cálculo ---

// Piso IDs con movimientos en este año
const pisoIdsConMovs = new Set<string>();
for (const m of movimientos) {
  pisoIdsConMovs.add(m.piso_id);
}

const pisosActivos = pisos.filter((p) => pisoIdsConMovs.has(p.id));

// Resumen global para widget Totales
function resumenGlobal(movs: MovimientoRds[], promos: PromoRds[]) {
  let totalGastos = 0;
  let totalIngresos = 0;
  for (const m of movs) {
	totalGastos += m.gasto ?? 0;
	totalIngresos += m.ingreso ?? 0;
  }

  let totalPromos = 0;
  for (const p of promos) {
	totalPromos += p.importe ?? 0;
  }

  return { totalGastos, totalIngresos, totalPromos };
}

const resumen = resumenGlobal(movimientos, promos);

// Mapa promo por mes
const promoPorMes: Record<number, number> = {};
for (const p of promos) {
  const mes = p.mes;
  if (!promoPorMes[mes]) promoPorMes[mes] = 0;
  promoPorMes[mes] += p.importe ?? 0;
}

// Resumen mensual global para widget Calendario
function buildMesesResumen(movs: MovimientoRds[], promos: PromoRds[], anio: number) {
  const byMes: Record<
	number,
	{ gastos: number; ingresos: number }
  > = {};

  for (const m of movs) {
	if (m.anio !== anio) continue;
	if (!byMes[m.mes]) {
	  byMes[m.mes] = { gastos: 0, ingresos: 0 };
	}
	byMes[m.mes].gastos += m.gasto ?? 0;
	byMes[m.mes].ingresos += m.ingreso ?? 0;
  }

  const promoByMesLocal: Record<number, number> = {};
  for (const p of promos) {
	if (p.anio !== anio) continue;
	if (!promoByMesLocal[p.mes]) promoByMesLocal[p.mes] = 0;
	promoByMesLocal[p.mes] += p.importe ?? 0;
  }

  return Array.from({ length: 12 }, (_, idx) => {
	const mesNum = idx + 1;
	const base = byMes[mesNum] ?? { gastos: 0, ingresos: 0 };
	const promo = promoByMesLocal[mesNum] ?? 0;
	const balance = base.ingresos - base.gastos;
	const balanceAjustado = balance - promo;

	return {
	  mes: mesNum,
	  gastos: base.gastos,
	  ingresos: base.ingresos,
	  promocion: promo,
	  balance,
	  balanceAjustado,
	};
  });
}

const mesesResumen = buildMesesResumen(movimientos, promos, selectedYear);

// Resumen por piso (sin promo)
function resumenPorPiso(movs: MovimientoRds[], anio: number) {
  const map: Record<string, { gastos: number; ingresos: number }> = {};

  for (const m of movs) {
	if (m.anio !== anio) continue;
	if (!map[m.piso_id]) {
	  map[m.piso_id] = { gastos: 0, ingresos: 0 };
	}
	map[m.piso_id].gastos += m.gasto ?? 0;
	map[m.piso_id].ingresos += m.ingreso ?? 0;
  }

  return map;
}

const resumenPisos = resumenPorPiso(movimientos, selectedYear);

// Meses por piso (sin promo, solo gasto/ingreso/balance)
function mesesPorPiso(pisoId: string) {
  const byMes: Record<number, { gasto: number; ingreso: number }> = {};

  for (const m of movimientos) {
	if (m.piso_id !== pisoId || m.anio !== selectedYear) continue;
	byMes[m.mes] = {
	  gasto: m.gasto ?? 0,
	  ingreso: m.ingreso ?? 0,
	};
  }

  return Array.from({ length: 12 }, (_, idx) => {
	const mesNum = idx + 1;
	const base = byMes[mesNum] ?? { gasto: 0, ingreso: 0 };
	const balance = base.ingreso - base.gasto;
	return {
	  mes: mesNum,
	  ...base,
	  balance,
	};
  });
}

const nombresMes = [
  "Ene", "Feb", "Mar", "Abr",
  "May", "Jun", "Jul", "Ago",
  "Sep", "Oct", "Nov", "Dic"
];

function formatMoneyEs(n: number): string {
  if (!Number.isFinite(n)) return "";
  return new Intl.NumberFormat("es-ES", {
	minimumFractionDigits: 2,
	maximumFractionDigits: 2,
  }).format(n);
}
const pageTitle = `RDS · ${selectedYear ?? "TOTALES"}`;
---

<Layout title={pageTitle}>
	<div class="main-content">
		<SectionHeader title={pageTitle} />
		<section class="section-toolbar">
			<div class="year-filter">
				<form method="get" class="year-filter-form">
				<select id="year" name="year" class="year-filter__select">
					{Array.from({ length: 6 }, (_, i) => {
					const y = currentYear - 2 + i;
					return (
						<option value={y} selected={y === selectedYear}>
						{y}
						</option>
					);
					})}
				</select>
				<noscript>
					<button type="submit">Aplicar</button>
				</noscript>
				</form>
			</div>
		</section>
		<section class="section-widgets">
		<RdsCountWidget
			pisos={pisosActivos}
			label={`Pisos`}
		/>
	
		<RdsTotalsWidget resumen={resumen} />
	
		<RdsCalendarWidget
			anio={selectedYear}
			meses={mesesResumen}
		/>
		</section>
		<section class="section-table">
			{pisosActivos.length === 0 ? (
				<p class="muted">
				No hay movimientos registrados para ningún piso en {selectedYear}.
				</p>
			) : (
				<table class="table-full">
				<thead>
					<tr>
						<th>Piso</th>
						<th >Dirección</th>
						<th>Gastos</th>
						<th>Ingresos</th>
						<th>Beneficio</th>
					</tr>
				</thead>
				<tbody>
					{pisosActivos.map((piso) => {
					const res = resumenPisos[piso.id] ?? {
						gastos: 0,
						ingresos: 0,
					};
					const beneficio = res.ingresos - res.gastos;
					const mesesPiso = mesesPorPiso(piso.id);
			
					return (
						<>
						<tr>
							<td>{piso.nombre}</td>
							<td>{piso.direccion}</td>
							<td>{formatMoneyEs(res.gastos)}</td>
							<td>{formatMoneyEs(res.ingresos)}</td>
							<td>{formatMoneyEs(beneficio)}</td>
						</tr>
						<tr>
							<td colspan="5">
								<details>
									<summary>Ver meses</summary>
									<table class="rds-mini-meses">
										<thead>
										<tr>
											<th></th>
											{mesesPiso.map((m) => (
											<th>{nombresMes[m.mes - 1]}</th>
											))}
										</tr>
										</thead>
										<tbody>
										<tr>
											<th>Gasto</th>
											{mesesPiso.map((m) => (
											<td>{formatMoneyEs(m.gasto)}</td>
											))}
										</tr>
										<tr>
											<th>Ingreso</th>
											{mesesPiso.map((m) => (
											<td>{formatMoneyEs(m.ingreso)}</td>
											))}
										</tr>
										<tr>
											<th>Balance</th>
											{mesesPiso.map((m) => (
											<td>{formatMoneyEs(m.balance)}</td>
											))}
										</tr>
										</tbody>
									</table>
									</details>
							</td>
						</tr>
						</>
					);
					})}
				</tbody>
				</table>
			)}
		</section>
	</div>
</Layout>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
	const form = document.querySelector('.year-filter-form');
	if (!form) return;
	const select = form.querySelector('select[name="year"]');
	if (!select) return;

	select.addEventListener('change', () => {
	  form.submit();
	});
  });
</script>