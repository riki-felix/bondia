---
export const prerender = false;

import "../../../src/styles/pages/propiedades.css";
import "../../../src/styles/components/tables.css";

import Layout from "../../components/Layout.astro";
import TotalsWidget from "../../widgets/TotalsWidget.astro";
import DifferenceWidget from "../../widgets/DifferenceWidget.astro";

import { supabaseServer } from "../../lib/supabaseServer";
import { formatEuro } from "../../lib/money";

/* ============================================================
   HELPERS
============================================================ */

const cap = (s?: string | null) =>
  s ? s.charAt(0).toUpperCase() + s.slice(1).toLowerCase() : "—";

const LUZ_AGUA_LABELS: Record<string, string> = {
  sin_suministro: "Sin suministro",
  pinchada: "Pinchada",
  contratada: "Contratada",
};

const GAS_LABELS: Record<string, string> = {
  sin_suministro: "Sin suministro",
  pinchado: "Pinchado",
  contratado: "Contratado",
};

const labelLuzAgua = (k?: string | null) =>
  (k && LUZ_AGUA_LABELS[k]) || "—";

const labelGas = (k?: string | null) =>
  (k && GAS_LABELS[k]) || "—";

const base = import.meta.env.PUBLIC_SUPABASE_URL;

const { slug } = Astro.params;

/* ============================================================
   1) Cargar propiedad
============================================================ */
const { data: propiedad, error: propError } = await supabaseServer()
  .from("propiedades")
  .select("*")
  .eq("slug", slug)
  .single();

if (propError || !propiedad) {
  Astro.response.status = 404;
  throw new Error(propError?.message ?? "Propiedad no encontrada");
}

/* ============================================================
   2) Cargar movimientos
============================================================ */
const { data: movimientos, error: movError } = await supabaseServer()
  .from("movimientos")
  .select("*")
  .eq("propiedad_id", propiedad.id);

/* ============================================================
   3) URLs de imagen y plano
============================================================ */
const fotoUrl = propiedad.foto_destacada_path
  ? `${base}/storage/v1/object/public/property-images/${propiedad.foto_destacada_path}`
  : null;

const planoUrl = propiedad.plano_path
  ? `${base}/storage/v1/object/public/property-plans/${propiedad.plano_path}`
  : null;

/* ============================================================
   4) URL de retorno según tipo
============================================================ */
let backUrl = "/propiedades";
if (propiedad?.tipo === "inversion") {
  backUrl = "/inversiones";
} else if (propiedad?.tipo === "activo") {
  backUrl = "/sanyus/activos";
}

/* ============================================================
   5) Totales de movimientos
============================================================ */
const movimientosGasto =
  movimientos?.filter((m) => {
	const tipo = (m.tipo_movimiento ?? "")
	  .normalize("NFD")
	  .replace(/[\u0300-\u036f]/g, "")
	  .toLowerCase()
	  .trim();
	return tipo !== "aportacion";
  }) ?? [];

const totals = movimientosGasto.reduce(
  (acc, m) => {
	const imp = Number(m.importe) || 0;
	acc.total += imp;
	if (m.estado === "pagado") acc.pagado += imp;
	if (m.estado === "pendiente") acc.pendiente += imp;
	return acc;
  },
  { total: 0, pagado: 0, pendiente: 0 }
);
---

<Layout title={propiedad.titulo}>
	<div class="main-content">
		<header class="main-header">
			<p>Creada el {new Date(propiedad.created_at).toLocaleString("es-ES")}</p>
			<p><a href={backUrl}>← Volver al listado</a></p>
			<a href={`/admin/propiedad/${propiedad.slug}/editar`} class="button--small">
			Editar
			</a>
		</header>
		<section class="property-info">
			<div class="leading-block property-images">
				{fotoUrl && (
					<img
					src={fotoUrl}
					alt={`Foto de ${propiedad.titulo}`}
					loading="lazy"
					/>
				)}
			
				{planoUrl && (
					<img
					src={planoUrl}
					alt={`Plano de ${propiedad.titulo}`}
					loading="lazy"
					style="max-width:640px;height:auto;border:1px solid #ddd;border-radius:8px;"
					/>
				)}
			</div>
			<div class="trailing-block property-metadata">
				<div class="property-block">
					<h1>{propiedad.titulo}</h1>
					<span class="block-value">{cap(propiedad.estado)}</span>
					<span class="block-value">{propiedad.direccion ?? ""}</span>
					<span class="block-value">{propiedad.superficie_m2 ?? ""}</span>
					<span class="block-value">Construido en {propiedad.anio_construccion ?? "—"}</span>
					<span class="block-value">Nº Catastro: {propiedad.numero_catastro ?? ""}</span>
					<span class="block-value">{cap(propiedad.tipo)}</span>
				</div>
		
				<div class="property-block compra-venta">
					<h3>Compra - Venta</h3>
					<span class="block-value">Comprado por {formatEuro(propiedad.precio_compra)}</span>
					<span class="block-value">Vendido por {formatEuro(propiedad.precio_venta)}</span>
					<span class="block-value">IVA 10%: {formatEuro(propiedad.iva_10)}</span>
					<span class="block-value">Valor catastral: {formatEuro(propiedad.valor_catastro)}</span>
					<span class="block-value">
					Fecha compra:{" "}
					{propiedad.fecha_compra
						? new Date(propiedad.fecha_compra).toLocaleDateString("es-ES")
						: "—"}
					</span>
					{propiedad.alquiler_previsto && (
					<span class="block-value">Alquiler previsto: {formatEuro(propiedad.alquiler_previsto)}</span>
					)}
				</div>
		
				<div class="property-block gastos-fijos">
					<h3>Gastos Fijos</h3>
					<span class="block-value">Valor ITE: {formatEuro(propiedad.valor_ite)}</span>
					<span class="block-value">Coste administrador: {formatEuro(propiedad.coste_administrador)}</span>
					<span class="block-value">Cuota comunidad: {formatEuro(propiedad.cuota_comunidad)}</span>
					<span class="block-value">Periodicidad cuota: {propiedad.periodicidad_cuota ?? "—"}</span>
					<span class="block-value">IBI: {formatEuro(propiedad.ibi)}</span>
					<span class="block-value">Suministro luz: {labelLuzAgua(propiedad.suministro_luz)}</span>
					<span class="block-value">Suministro agua: {labelLuzAgua(propiedad.suministro_agua)}</span>
					<span class="block-value">Suministro gas: {labelGas(propiedad.suministro_gas)}</span>
				</div>
		
				<!-- METADATOS -->
				<div class="property-block metadata">
					<span>Creado: {new Date(propiedad.created_at).toLocaleString("es-ES")}</span>
					<span>Actualizado: {new Date(propiedad.updated_at).toLocaleString("es-ES")}</span>
				</div>
			</div>
		</section>
		<section class="property-data">
			<div class="widgets">
				<TotalsWidget size="5" totals={totals} movimientos={movimientos ?? []} />
				<DifferenceWidget size="5" precio_venta={propiedad.precio_venta} totals={totals} />
			</div>
			<div class="block movements section-table">
				<table class="table-full">
					<thead>
				<tr>
					<th>Tipo</th>
					<th>Concepto</th>
					<th>Importe</th>
					<th>Estado</th>
					<th>Fecha</th>
				</tr>
				</thead>
					<tbody>
				{movimientos?.length ? (
					movimientos.map((m) => (
					<tr>
						<td>{cap(m.tipo_movimiento)}</td>
						<td>{m.concepto ?? "—"}</td>
						<td>{formatEuro(m.importe)}</td>
						<td>{cap(m.estado)}</td>
						<td>
						{m.fecha
							? new Date(m.fecha).toLocaleDateString("es-ES")
							: "—"}
						</td>
					</tr>
					))
				) : (
					<tr>
					<td colspan="5" class="muted">
						No hay movimientos.
					</td>
					</tr>
				)}
				</tbody>
				</table>
			</div>
		</section>
	</div>
</Layout>