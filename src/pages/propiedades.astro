---
export const prerender = false;

import Layout from "../components/Layout.astro";

import { createClient } from '@supabase/supabase-js'
import { publicImageUrl } from '../lib/imageUrl'

const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY
)

const { data: properties, error } = await supabase
  .from('properties')
  .select('*')
  .order('created_at', { ascending: false })
---

<Layout title="Propiedades" description="Listado de propiedades">
  <section>
	<h1>Propiedades</h1>

	{error && <p class="">Error: {error.message}</p>}

	<ul class="">
	  {properties?.map((p) => {
		const img = publicImageUrl(p.image_path);
		return (
		  <li class="">
			{img && <img src={img} alt={p.title} class="" loading="lazy" />}
			<h2 class="">
			  <a href={`/propiedad/${p.slug}`}>{p.title}</a>
			</h2>
			<p class="">{p.address}</p>
		  </li>
		);
	  })}
	</ul>

	<p class="">
	  <a href="/admin/new" class="">+ Nueva propiedad</a>
	</p>
  </section>
</Layout>