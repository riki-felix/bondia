---
export const prerender = false;
import '../../src/styles/pages/propiedades.css';
import Layout from "../components/Layout.astro";
import { publicImageUrl } from '../lib/imageUrl';

// Cliente Supabase (anon) para ejecutar en el frontmatter (SSR)
import { supabaseClient } from "../lib/supabaseClient";

const supabase = supabaseClient();

// Traemos las propiedades más recientes primero
const { data: properties, error } = await supabase
  .from('propiedades')
  .select('*')
  .order('created_at', { ascending: false });

// Helper para construir una línea de dirección legible
function formatDireccion(p: any) {
  const linea1 = [p?.direccion_via, p?.direccion_numero].filter(Boolean).join(' ');
  const linea2 = [p?.codigo_postal, p?.ciudad, p?.provincia].filter(Boolean).join(' ');
  return [linea1, linea2].filter(Boolean).join(', ');
}
---

<Layout title="Propiedades">
  <section>
	<h1>Propiedades</h1>
	{error && <p class="">Error: {error.message}</p>}

	<ul class="">
	  {properties?.map((p: any) => {
		const img = publicImageUrl(p.foto_destacada_path);
		const direccion = formatDireccion(p);
		const fallback =
		  "https://zcezehuuxkravxjfdrbm.supabase.co/storage/v1/object/public/property-images/b73d9021-c747-45af-888a-e6caaddda308/1762017591772_casa_2.png";
	  
		return (
		  <li class="">
			<img
			  src={img || fallback}
			  alt={p.titulo}
			  class=""
			  loading="lazy"
			/>
	  
			<h2>
			  <a href={`/propiedad/${p.slug}`}>{p.titulo}</a>
			</h2>
	  
			{direccion && <p>{direccion}</p>}
		  </li>
		);
	  })}
	</ul>

	<p class="">
	  <a href="/admin/nueva" class="">+ Nueva propiedad</a>
	</p>
  </section>
</Layout>