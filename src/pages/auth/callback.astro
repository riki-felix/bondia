---
export const prerender = false;
---
<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Authenticating...</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .container {
        text-align: center;
        padding: 2rem;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      .error {
        background: rgba(239, 68, 68, 0.9);
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        max-width: 500px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="spinner"></div>
      <p id="status">Processing authentication...</p>
      <div id="error" class="error" style="display: none;"></div>
    </div>
    
    <script is:inline type="module">
      const statusEl = document.getElementById('status');
      const errorEl = document.getElementById('error');

      /**
       * Display an error message and redirect to login after a delay
       */
      function showError(message) {
        console.error('[Auth Callback]', message);
        statusEl.textContent = 'Authentication failed';
        errorEl.textContent = message;
        errorEl.style.display = 'block';
        
        setTimeout(() => {
          const encodedError = encodeURIComponent(message);
          window.location.replace(`/login?error=${encodedError}`);
        }, 3000);
      }

      /**
       * Send authentication data to server to establish session
       */
      async function establishSession(payload) {
        try {
          const response = await fetch('/api/auth/set', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
            credentials: 'same-origin',
          });

          if (!response.ok) {
            let errorMsg = 'Failed to establish session';
            try {
              const data = await response.json();
              errorMsg = data.error || errorMsg;
            } catch {
              errorMsg = await response.text() || errorMsg;
            }
            throw new Error(errorMsg);
          }

          console.log('[Auth Callback] Session established successfully');
          return true;
        } catch (error) {
          console.error('[Auth Callback] Error establishing session:', error);
          throw error;
        }
      }

      /**
       * Main authentication callback handler
       */
      async function handleAuthCallback() {
        try {
          const url = new URL(window.location.href);
          
          // Check for query parameter errors first
          const errorParam = url.searchParams.get('error');
          const errorDescription = url.searchParams.get('error_description');
          
          if (errorParam) {
            if (errorParam === 'otp_expired') {
              showError('The magic link has expired. Please request a new one.');
              return;
            }
            showError(errorDescription || 'Authentication failed. Please try again.');
            return;
          }

          // Check for PKCE code (OAuth flow)
          if (url.searchParams.has('code')) {
            console.log('[Auth Callback] Processing PKCE code flow');
            statusEl.textContent = 'Verifying authentication code...';
            await establishSession({ codeUrl: url.href });
            
            // Clean up URL and redirect
            window.history.replaceState({}, '', '/auth/callback');
            statusEl.textContent = 'Success! Redirecting...';
            window.location.replace('/admin');
            return;
          }

          // Check for token_hash (verifyOtp flow - newer Supabase method)
          if (url.searchParams.has('token_hash')) {
            console.log('[Auth Callback] Processing token_hash flow');
            statusEl.textContent = 'Verifying magic link...';
            const token_hash = url.searchParams.get('token_hash');
            const type = url.searchParams.get('type') || 'magiclink';
            await establishSession({ token_hash, type });
            
            // Clean up URL and redirect
            window.history.replaceState({}, '', '/auth/callback');
            statusEl.textContent = 'Success! Redirecting...';
            window.location.replace('/admin');
            return;
          }

          // Check for hash-based tokens (legacy magic link flow)
          if (window.location.hash && window.location.hash.includes('access_token')) {
            console.log('[Auth Callback] Processing hash-based token flow');
            statusEl.textContent = 'Establishing session...';
            
            const hashParams = new URLSearchParams(window.location.hash.slice(1));
            const access_token = hashParams.get('access_token');
            const refresh_token = hashParams.get('refresh_token');

            if (!access_token || !refresh_token) {
              showError('Missing authentication tokens. Please try logging in again.');
              return;
            }

            await establishSession({ access_token, refresh_token });
            
            // Clean up URL and redirect
            window.history.replaceState({}, '', '/auth/callback');
            statusEl.textContent = 'Success! Redirecting...';
            window.location.replace('/admin');
            return;
          }

          // No valid authentication data found
          showError('No authentication data found. Please try logging in again.');
          
        } catch (error) {
          showError(error.message || 'An unexpected error occurred. Please try again.');
        }
      }

      // Start the authentication process when the page loads
      window.addEventListener('load', handleAuthCallback);
    </script>
  </body>
</html>