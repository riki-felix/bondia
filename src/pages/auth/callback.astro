---
import { createSupabaseServerClient } from '../../lib/supabaseServer';

export const prerender = false;

// Handle the OAuth callback
const supabase = createSupabaseServerClient(Astro.cookies, Astro.request);

// Get the code from the URL (for PKCE flow)
const code = Astro.url.searchParams.get('code');

if (code) {
  // Exchange the code for a session
  const { error } = await supabase.auth.exchangeCodeForSession(code);

  if (error) {
    console.error('Auth callback error:', error);
    return Astro.redirect('/login?error=invalid_credentials');
  }

  // Verify the session was created
  const { data: { session } } = await supabase.auth.getSession();
  
  if (!session) {
    console.error('Session not established after code exchange');
    return Astro.redirect('/login?error=session_failed');
  }

  // Redirect to admin page after successful login
  return Astro.redirect('/admin');
}

// If no code in query params, check for tokens in URL fragment (handled client-side below)
// This is necessary because fragments (#access_token, #refresh_token) are not sent to the server
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Autenticando...</title>
    <style>
      body {
        font-family: system-ui, -apple-system, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        background: #f5f5f5;
      }
      .container {
        text-align: center;
        padding: 2rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #0066cc;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 1rem auto;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Autenticando...</h1>
      <div class="spinner"></div>
      <p>Por favor, espera mientras procesamos tu inicio de sesi√≥n.</p>
    </div>

    <script>
      import { supabase } from '../../scripts/supabaseClient.js';

      async function handleAuthCallback() {
        try {
          // Check if we have tokens in the URL fragment
          const hashParams = new URLSearchParams(window.location.hash.substring(1));
          const accessToken = hashParams.get('access_token');
          const refreshToken = hashParams.get('refresh_token');

          if (accessToken && refreshToken) {
            console.log('Found tokens in URL fragment, establishing session...');
            
            // Use setSession to establish the session with the tokens from the fragment
            const { data, error } = await supabase.auth.setSession({
              access_token: accessToken,
              refresh_token: refreshToken,
            });

            if (error) {
              console.error('Error setting session from fragment tokens:', error);
              window.location.href = '/login?error=invalid_magic_link';
              return;
            }

            if (data.session) {
              console.log('Session established successfully from fragment tokens');
              // Redirect to admin page after successful login
              window.location.href = '/admin';
              return;
            } else {
              console.error('Session not established after setSession');
              window.location.href = '/login?error=session_failed';
              return;
            }
          }

          // If we reach here and there's no code either, show an error
          const urlParams = new URLSearchParams(window.location.search);
          const code = urlParams.get('code');
          
          if (!code) {
            console.error('No authentication code or tokens found in callback URL');
            window.location.href = '/login?error=no_code';
          }
          // If there is a code, the server-side logic above will handle it
          // We just wait for the server redirect
        } catch (err) {
          console.error('Unexpected error in auth callback:', err);
          window.location.href = '/login?error=invalid_magic_link';
        }
      }

      // Run the callback handler
      handleAuthCallback();
    </script>
  </body>
</html>
