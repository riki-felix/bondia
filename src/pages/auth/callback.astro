---
export const prerender = false;
---
<html>
  <body>
    <p>Processing authentication...</p>
    <script is:inline type="module">
      import { supabase } from '/src/scripts/supabaseClient.js';

      const url = new URL(location.href);
      const hashParams = new URLSearchParams(url.hash.slice(1));
      const access_token = hashParams.get('access_token');
      const refresh_token = hashParams.get('refresh_token');

      // Handle expired OTP links with detailed logging
      const errorParam = url.searchParams.get('error');
      const errorDescription = url.searchParams.get('error_description');
      
      if (errorParam === 'otp_expired') {
        console.error("[Auth Callback] Magic link expired:", errorDescription || 'No additional details');
        location.replace('/login?error=The magic link has expired. Please request a new one.');
        return;
      }
      
      // Handle other authentication errors
      if (errorParam) {
        console.error("[Auth Callback] Authentication error:", errorParam, errorDescription || '');
        const message = encodeURIComponent(errorDescription || 'Authentication failed. Please try again.');
        location.replace(`/login?error=${message}`);
        return;
      }

      // Handle missing tokens with detailed logging
      if (!access_token || !refresh_token) {
        console.error("[Auth Callback] Missing tokens in URL fragment. access_token:", !!access_token, "refresh_token:", !!refresh_token);
        location.replace('/login?error=Missing authentication tokens. Please try logging in again.');
        return;
      }

      // Attempt to set session
      try {
        console.log("[Auth Callback] Attempting to establish session...");
        const { error } = await supabase.auth.setSession({ access_token, refresh_token });
        
        if (error) {
          console.error("[Auth Callback] Failed to establish session:", error.message);
          const message = encodeURIComponent(error.message || 'Failed to establish session');
          location.replace(`/login?error=${message}`);
        } else {
          console.log("[Auth Callback] Session established successfully. Redirecting to admin...");
          location.replace('/admin');
        }
      } catch (err) {
        console.error("[Auth Callback] Unexpected error during session setup:", err);
        location.replace('/login?error=An unexpected error occurred. Please try again.');
      }
    </script>
  </body>
</html>