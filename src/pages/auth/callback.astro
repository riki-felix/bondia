---
export const prerender = false;
---
<html>
  <body>
    <p>Processing authentication...</p>
    <script is:inline type="module">
      import { supabase } from '/src/scripts/supabaseClient.js';

      const url = new URL(location.href);
      const hashParams = new URLSearchParams(url.hash.slice(1));
      const access_token = hashParams.get('access_token');
      const refresh_token = hashParams.get('refresh_token');

      // Handle expired links
      if (url.searchParams.get('error') === 'otp_expired') {
        console.error("Magic link expired.");
        location.replace(`/login?error=link-expired`);
      }

      if (!access_token || !refresh_token) {
        console.error("Missing tokens in URL fragment.");
        location.replace('/login?error=missing-tokens');
      } else {
        const { error } = await supabase.auth.setSession({ access_token, refresh_token });
        if (error) {
          console.error("Failed to establish session:", error.message);
          location.replace(`/login?error=failed-session`);
        } else {
          console.log("Session established successfully.");
          location.replace('/admin');
        }
      }
    </script>
  </body>
</html>