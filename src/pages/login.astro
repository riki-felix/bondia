---
import '../../src/styles/base/reset.css';
import '../../src/styles/base/tokens.css';
import '../../src/styles/base/typography.css';
import '../../src/styles/base/base.css';
import '../../src/styles/components/forms.css';
import '../../src/styles/layout/auth-module.css';
import Head from '../components/Head.astro';

export const prerender = false;

// Extract error and redirect parameters from URL
const url = new URL(Astro.request.url);
const errorMessage = url.searchParams.get('error');
const redirectUrl = url.searchParams.get('redirect');
---

<!doctype html>
<html lang="es">
  <Head />
  <body class="login">
    <section class="login-form">
      <header>
        <svg width="154" height="39" viewBox="0 0 154 39" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M43.0674 11.4395C50.7634 11.4395 55.7559 17.42 55.7559 24.96C55.7557 32.4998 50.7633 38.4795 43.0674 38.4795C35.3715 38.4795 30.38 32.4998 30.3799 24.96C30.3799 17.42 35.3714 11.4395 43.0674 11.4395ZM111.209 33.4873C111.209 35.6193 111.625 35.7234 115.213 35.9834V37.3359L106.529 38.4795H105.801L105.697 34.7354H105.437C103.617 36.9194 100.757 38.4795 97.6367 38.4795C90.9809 38.4794 87.0294 32.7598 87.0293 24.96C87.0293 16.484 92.8528 11.4395 99.3008 11.4395C100.965 11.4395 103.721 11.8557 105.437 13.1035V4.99121C105.436 2.85966 105.02 2.75607 101.433 2.49609V1.14355L110.48 0H111.209V33.4873ZM141.112 11.4395C146.78 11.4395 149.641 14.7676 149.589 19.1875V33.6953C149.589 34.6833 150.161 35.2041 151.097 35.2041C151.877 35.2041 152.761 34.8398 153.749 34.2158L154.009 35.5156C152.085 36.9716 149.485 38.4794 147.093 38.4795C144.597 38.4795 143.816 36.9714 143.816 35.1514V34.3193H143.713C141.373 36.8673 138.721 38.4795 135.601 38.4795C131.597 38.4795 129.517 35.8277 129.517 32.5518C129.517 29.3278 131.909 25.3237 143.816 24.3877V19.5518C143.816 15.9118 142.1 13.7275 138.824 13.7275C136.016 13.7277 134.249 15.4442 134.249 16.9521C134.249 18.2516 135.549 18.4598 135.549 19.8633C135.549 20.9033 134.456 21.7354 132.948 21.7354C131.544 21.7352 130.297 21.0595 130.297 19.3438C130.297 16.7438 133.937 11.4396 141.112 11.4395ZM15.1846 1.55957C22.9844 1.5596 27.1444 5.19957 27.1445 10.3994C27.1445 14.5594 23.868 17.7837 19.708 18.9277V19.0312C26.208 20.3832 28.7041 24.3358 28.7041 28.3398C28.704 34.0597 24.5441 37.96 16.7441 37.96H0V36.5039C3.58791 36.2439 4.00486 36.1397 4.00488 34.2158V5.30371C4.00488 3.37971 3.588 3.27562 0 3.01562V1.55957H15.1846ZM66.3086 16.8994H66.5684C69.0644 13.8315 72.5488 11.4395 76.3447 11.4395C79.9845 11.4395 83.1043 13.5197 83.1045 19.2393V34.3193C83.1045 36.2433 83.5205 36.3474 87.1084 36.6074V37.96H74.1602V36.6074C76.9162 36.3474 77.332 36.2433 77.332 34.3193V19.6553C77.3319 17.1076 76.0845 15.4963 73.5889 15.4961C70.573 15.4961 68.1284 17.1593 66.5684 18.6152V34.3193C66.5684 36.2433 66.9845 36.3474 70.5723 36.6074V37.96H56.793V36.6074C60.3805 36.3474 60.7969 36.2432 60.7969 34.3193V17.4717C60.7969 15.3398 60.3805 15.2356 56.793 14.9756V13.624L65.8408 11.4395H66.5684L66.3086 16.8994ZM125.046 34.3193C125.046 36.2433 125.462 36.3474 129.05 36.6074V37.96H115.271V36.6074C118.858 36.3474 119.274 36.2432 119.274 34.3193V17.4717C119.274 15.3398 118.858 15.2356 115.271 14.9756V13.624L124.318 11.4395H125.046V34.3193ZM43.0674 13.4678C38.9594 13.4678 36.5156 17.16 36.5156 24.96C36.5157 32.7598 38.9594 36.4521 43.0674 36.4521C47.1753 36.4521 49.6191 32.7598 49.6191 24.96C49.6191 17.16 47.1754 13.4678 43.0674 13.4678ZM9.98438 35.9834H15.1328C21.0083 35.9833 22.3603 32.2398 22.3604 28.0801C22.3604 23.5041 19.8646 20.2276 13.8848 20.2275H9.98438V35.9834ZM100.133 13.4678C95.2968 13.4678 93.165 18.148 93.165 24.752C93.1651 31.8238 96.3891 35.1514 100.289 35.1514C102.317 35.1513 104.085 34.1634 105.437 33.0195V20.54C105.437 14.768 102.317 13.4678 100.133 13.4678ZM143.816 26.0518C137.681 26.8318 135.393 28.4957 135.393 31.3037C135.393 33.3835 136.744 34.6317 138.616 34.6318C140.436 34.6318 142.204 33.6437 143.816 32.5518V26.0518ZM9.98438 18.0439H13.5723C18.7202 18.0439 21.0087 15.0798 21.0088 10.9199C21.0088 6.75992 19.1883 3.53613 14.1963 3.53613H9.98438V18.0439ZM121.978 1.87207C124.11 1.87207 125.774 3.17195 125.774 5.25195C125.774 7.38378 124.109 8.63184 121.978 8.63184C119.846 8.63165 118.182 7.38362 118.182 5.25195C118.182 3.17211 119.846 1.87227 121.978 1.87207Z" fill="#FFF6E1"/>
        </svg>
      </header>
      {errorMessage && (
        <div style="color: #ff6b6b; background: rgba(255, 107, 107, 0.1); padding: 12px; border-radius: 4px; margin-bottom: 16px; font-size: 14px;">
          {errorMessage}
        </div>
      )}
      <form id="login-form">
        <input id="email" type="email" name="email" placeholder="tu@email.com" required />
        <button id="login-button" type="submit">Acceder</button>
      </form>
      <p id="msg"></p>
    </section>
    <canvas id="bg"></canvas>
    <div id="bg-blur"></div>
    <script is:inline type="module">
      import { supabase } from '/src/scripts/supabaseClient.js';
      import { sendMagicLink } from '/src/scripts/supabase-auth-sign-in.js';
      
      
      const form = document.getElementById('login-form');
      const msg = document.getElementById('msg');
      
      const emailInput = document.querySelector('#email');
      const loginButton = document.querySelector('#login-button');
      
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = form.email.value.trim();
        msg.textContent = 'Sending magic link...';
        msg.style.color = '#FFF6E1';
        
        const response = await sendMagicLink(email);
        if (!response.success) {
          msg.textContent = `Error: ${response.message}`;
          msg.style.color = '#ff6b6b';
        } else {
          msg.textContent = 'Check your email for the magic link!';
          msg.style.color = '#4ade80';
        }
      });
    </script>
    
    <script>
    (() => {
      // Variables de paleta, transiciÃ³n y estado
      const PALETTE_START = {
        skyTop:   '#00051c',
        skyMid:   '#020b1d',
        skyLow:   '#0c1830',
        blob:     '#00193e'
      };
      const PALETTE_END = {
        skyTop:   '#ffbb00',
        skyMid:   '#fbc221',
        skyLow:   '#d79201',
        blob:     '#c47601'
      };
      const TRANSITION_MS = 30000;
      const state = { start: performance.now(), progress: 0 };

      const canvas = document.getElementById('bg') as HTMLCanvasElement | null;
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));

      // Funciones de color y easing
      const hexToRgb = (h: string) => {
        const s = h.replace('#','');
        return s.length === 3
          ? [parseInt(s[0]+s[0],16), parseInt(s[1]+s[1],16), parseInt(s[2]+s[2],16)]
          : [parseInt(s.slice(0,2),16), parseInt(s.slice(2,4),16), parseInt(s.slice(4,6),16)];
      };
      const lerp = (a: number, b: number, t: number) => a + (b - a) * t;
      const lerpColor = (ha: string, hb: string, t: number) => {
        const [r1,g1,b1] = hexToRgb(ha), [r2,g2,b2] = hexToRgb(hb);
        return `rgb(${(lerp(r1,r2,t)|0)}, ${(lerp(g1,g2,t)|0)}, ${(lerp(b1,b2,t)|0)})`;
      };
      const ease = (t: number) => t<0.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2;

      function setSize() {
        const { innerWidth: w, innerHeight: h } = window;
        if (!canvas || !ctx) return;
        canvas.width = w * DPR;
        canvas.height = h * DPR;
        canvas.style.width  = w + 'px';
        canvas.style.height = h + 'px';
        ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
      }
      setSize();
      window.addEventListener('resize', setSize, { passive: true });

      const N = 8;
      const points: any[] = [];
      let center = { x: 0.5, y: 0.5 };
      const drift = { x: 0.5, y: 0.55, vx: 0, vy: 0 };
      function initPoints() {
        points.length = 0;
        for (let i=0;i<N;i++){
          const a = (i / N) * Math.PI * 2;
          points.push({
            baseR: 0.25 + Math.random()*0.12,
            theta: a,
            amp: 0.035 + Math.random()*0.025,
            spd: 0.8 + Math.random()*0.6
          });
        }
      }
      initPoints();

      function drawBlob(w: number, h: number, color: string, t: number) {
        if (!ctx) return;
        const size = Math.min(w, h);
        const cx = center.x * w;
        const cy = center.y * h;
        const verts = points.map((p: any) => {
          const r = (p.baseR + Math.sin(t * p.spd + p.theta) * p.amp) * size;
          return { x: cx + Math.cos(p.theta) * r, y: cy + Math.sin(p.theta) * r };
        });

        ctx.save();
        ctx.filter = `blur(var(--blur))`;
        ctx.globalCompositeOperation = 'lighter'; // mezcla luminosa
        const grad = ctx.createRadialGradient(cx, cy, 0, cx, cy, size * 0.4);
        grad.addColorStop(0, color);
        grad.addColorStop(1, 'rgba(0,0,0,0)');
        ctx.fillStyle = grad;

        ctx.beginPath();
        const mid = (i: number) => {
          const a = verts[(i + N - 1) % N], b = verts[i];
          return { x: (a.x + b.x) / 2, y: (a.y + b.y) / 2 };
        };
        let m = mid(0);
        ctx.moveTo(m.x, m.y);
        for (let i=0; i<N; i++) {
          const p = verts[i];
          const nextM = mid((i + 1) % N);
          ctx.quadraticCurveTo(p.x, p.y, nextM.x, nextM.y);
        }
        ctx.closePath();
        ctx.fill();
        ctx.restore();
      }

      function paintBackground(w: number, h: number, t01: number) {
        if (!ctx) return;
        const t = ease(Math.min(1,t01));
        const top = lerpColor(PALETTE_START.skyTop, PALETTE_END.skyTop, t);
        const mid = lerpColor(PALETTE_START.skyMid, PALETTE_END.skyMid, t);
        const low = lerpColor(PALETTE_START.skyLow, PALETTE_END.skyLow, t);
        const g = ctx.createLinearGradient(0, 0, 0, h);
        g.addColorStop(0, top);
        g.addColorStop(0.55, mid);
        g.addColorStop(1, low);
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, w, h);
      }

      let last = performance.now();
      const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      function tick(now: number) {
        if (!canvas || !ctx) return;
        const dt = Math.min(0.033, (now - last) / 1000);
        last = now;
        const elapsed = now - state.start;
        state.progress = Math.min(1, elapsed / TRANSITION_MS);

        const wpx = canvas.width;
        const hpx = canvas.height;

        paintBackground(wpx / DPR, hpx / DPR, state.progress);

        if (!reduce) {
          drift.vx += (Math.random() - 0.5) * 0.0008;
          drift.vy += (Math.random() - 0.5) * 0.0008;
          drift.vx *= 0.985;
          drift.vy *= 0.985;
          drift.x = Math.max(0.28, Math.min(0.72, drift.x + drift.vx));
          drift.y = Math.max(0.40, Math.min(0.68, drift.y + drift.vy));
          center.x += (drift.x - center.x) * 0.02;
          center.y += (drift.y - center.y) * 0.02;
        }

        const t = now * (parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--speed')) || 0.0028);
        const blobColor = lerpColor(PALETTE_START.blob, PALETTE_END.blob, ease(state.progress));
        drawBlob(wpx / DPR, hpx / DPR, blobColor, t);

        if (!reduce) requestAnimationFrame(tick);
      }

      if (reduce) {
        state.progress = 1;
        if (!canvas || !ctx) return;
        paintBackground(canvas.width / DPR, canvas.height / DPR, 1);
        drawBlob(canvas.width / DPR, canvas.height / DPR, PALETTE_END.blob, 0);
      } else {
        requestAnimationFrame(tick);
      }
    })();
    </script>
  </body>
</html>