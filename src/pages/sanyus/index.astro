---
export const prerender = false;
import CountWidget from "../../widgets/CountWidget.astro";
import SumWidget from "../../widgets/SumWidget.astro";

import '../../../src/styles/pages/propiedades.css';

import Layout from "../../components/Layout.astro";
import { supabaseClient } from "../../lib/supabaseClient";
import { publicImageUrl } from '../../lib/imageUrl';

const supabase = supabaseClient();

const { data: properties, error } = await supabase
  .from("propiedades")
  .select("*")
  .eq("tipo", "activo")
  .order("created_at", { ascending: false });

const imgUrl = (p: any) =>
  p?.foto_destacada_path
	? `${import.meta.env.PUBLIC_SUPABASE_URL}/storage/v1/object/public/property-images/${p.foto_destacada_path}`
	: null;
---

<Layout title="Inversiones">
  <header class="main-header">
	<h1>Activos</h1>
	<div class="page-actions">
	  <a class="button--small" href="/admin/nueva">+ Nuevo Activo</a>
	</div>
  </header>
  <section class="widgets">
	<CountWidget propiedades={properties} tipo="activo" label="Activos Sanyus" />
	<CountWidget propiedades={properties} tipo="activo" estado="vendido" label="Activos Sanyus Vendidos" />
	<CountWidget propiedades={properties} tipo="activo" estado="alquiler" label="Alquilados" />
	<SumWidget propiedades={properties} tipo="activo" campo="precio_venta" estado="vendido" label="Total Ventas" />
	<SumWidget propiedades={properties} tipo="activo" campo="precio_compra" label="Total compras" />
  </section>
  {error && <p>❌ {error.message}</p>}

  {(!error && (!properties || properties.length === 0)) && (
	<p>No hay Activos</p>
  )}

  {properties && properties.length > 0 && (
	<div class="cards-grid">
	  {properties.map((p: any) => (
		<div class="card-item">
		  {imgUrl(p) && (
			<a class="card-img--link" href={`/propiedad/${p.slug}`}>
			  <img src={imgUrl(p)} alt={p.titulo} loading="lazy" />
			</a>
		  )}
		  <h2 class="card-title">
			<a class="card-link" href={`/propiedad/${p.slug}`}>{p.titulo}</a>
		  </h2>
		  <p class="card-meta">
			{p.superficie_m2 ? `${p.superficie_m2} m² · ` : ''}{p.estado ? p.estado : '—'}
		  </p>
		</div>
	  ))}
	</div>
  )}
</Layout>