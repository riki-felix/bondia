---
export const prerender = false;
import CountWidget from "../../widgets/CountWidget.astro";
import SumWidget from "../../widgets/SumWidget.astro";

import '../../../src/styles/pages/propiedades.css';

import Layout from "../../components/Layout.astro";
import SectionHeader from "../../components/SectionHeader.astro";
import { supabaseClient } from "../../lib/supabaseClient";
import { publicImageUrl } from '../../lib/imageUrl';

const supabase = supabaseClient();

const { data: properties, error } = await supabase
  .from("propiedades")
  .select("*")
  .eq("tipo", "activo")
  .order("created_at", { ascending: false });

const imgUrl = (p: any) =>
  p?.foto_destacada_path
	? `${import.meta.env.PUBLIC_SUPABASE_URL}/storage/v1/object/public/property-images/${p.foto_destacada_path}`
	: null;
---

<Layout title="Sanyus">
	<div class="main-content">
		<SectionHeader title="Sanyus" />
		<section class="section-widgets">
			<CountWidget
				size="10"
				propiedades={properties ?? []}
				tipo="activo"
				label="Activos Sanyus"
			/>
			<SumWidget
				size="3"
				propiedades={properties ?? []}
				tipo="activo"
				campo="precio_compra"
				estado="vendido"
				label="Compras totales"
			/>
			<CountWidget
				size="2"
				propiedades={properties ?? []}
				tipo="activo"
				estado="vendido"
				label="Pisos Vendidos"
			/>
			<SumWidget
				size="3"
				propiedades={properties ?? []}
				tipo="activo"
				campo="precio_venta"
				estado="vendido"
				label="Ventas totales"
			/>
			<CountWidget
				size="2"
				propiedades={properties ?? []}
				tipo="activo"
				estado="alquiler"
				label="Pisos en Alquiler"
			/>
		</section>
		{error && <p>❌ {error.message}</p>}
		
		{(!error && (!properties || properties.length === 0)) && (
			<p>No hay Activos</p>
		)}
		
		{properties && properties.length > 0 && (
			<div class="cards-grid">
			{properties.map((p: any) => (
				<div class="card-item">
				{imgUrl(p) && (
					<a class="card-img--link" href={`/propiedad/${p.slug}`}>
					<img src={imgUrl(p)} alt={p.titulo} loading="lazy" />
					</a>
				)}
				<h2 class="card-title">
					<a class="card-link" href={`/propiedad/${p.slug}`}>{p.titulo}</a>
				</h2>
				<p class="card-meta">
					{p.superficie_m2 ? `${p.superficie_m2} m² · ` : ''}{p.estado ? p.estado : '—'}
				</p>
				</div>
			))}
			</div>
		)}
	</div>
</Layout>